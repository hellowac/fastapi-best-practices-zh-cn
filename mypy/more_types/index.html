
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastApi 最佳实践-中文版">
      
      
      
      
        <link rel="prev" href="../generics/">
      
      
        <link rel="next" href="../literal_and_enum/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.12">
    
    
      
        <title>类型系统参考-更多类型 - FastApi 最佳实践-中文版</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#更多类型" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="FastApi 最佳实践-中文版" class="md-header__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastApi 最佳实践-中文版
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              类型系统参考-更多类型
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      最佳实践
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../raw_en/" class="md-tabs__link">
      英文原版
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../asyncio/asyncio/" class="md-tabs__link">
        Asyncio
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../cheat_sheet_py3/" class="md-tabs__link md-tabs__link--active">
        mypy
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../http/internet_protocol_suite_part_i/" class="md-tabs__link">
        HTTP
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../git/git-branch-manage/" class="md-tabs__link">
        Git
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../xml/" class="md-tabs__link">
      xml
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../sysdesign/perm_design/" class="md-tabs__link">
        系统设计
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      关于
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FastApi 最佳实践-中文版" class="md-nav__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FastApi 最佳实践-中文版
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        最佳实践
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../raw_en/" class="md-nav__link">
        英文原版
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Asyncio
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Asyncio
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/asyncio/" class="md-nav__link">
        中文简单指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/asyncio_en/" class="md-nav__link">
        中英对照指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/runner/" class="md-nav__link">
        Runner运行协程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/task_group/" class="md-nav__link">
        TaskGroup管理协程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/cheat_sheet/" class="md-nav__link">
        语法备忘录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/api_mind_map/" class="md-nav__link">
        API思维导图
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          mypy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          mypy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cheat_sheet_py3/" class="md-nav__link">
        类型注解备忘录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../builtin_types/" class="md-nav__link">
        类型系统参考-内置类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../type_inference_type_annotations/" class="md-nav__link">
        类型系统参考-类型推断和类型注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kind_of_types/" class="md-nav__link">
        类型系统参考-类型种类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../class_basics/" class="md-nav__link">
        类型系统参考-类的基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../annotation_issue_at_runtime/" class="md-nav__link">
        类型系统参考-运行时的注解问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protocol_and_struct_subtyping/" class="md-nav__link">
        类型系统参考-协议和结构子类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dynamic_typing/" class="md-nav__link">
        类型系统参考-类型收缩
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../type_narrowing/" class="md-nav__link">
        类型系统参考-类型收缩
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../duck_type_compatibility/" class="md-nav__link">
        类型系统参考-鸭子类型兼容
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stub_files/" class="md-nav__link">
        类型系统参考-存根文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../generics/" class="md-nav__link">
        类型系统参考-泛型
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          类型系统参考-更多类型
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        类型系统参考-更多类型
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aaa" class="md-nav__link">
    aaa
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-noreturn-type" class="md-nav__link">
    The NoReturn type
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#newtypes" class="md-nav__link">
    NewTypes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-overloading" class="md-nav__link">
    Function overloading
  </a>
  
    <nav class="md-nav" aria-label="Function overloading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-behavior" class="md-nav__link">
    Runtime behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-calls-to-overloads" class="md-nav__link">
    Type checking calls to overloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-the-variants" class="md-nav__link">
    Type checking the variants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-the-implementation" class="md-nav__link">
    Type checking the implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-overloads" class="md-nav__link">
    Conditional overloads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-uses-of-self-types" class="md-nav__link">
    Advanced uses of self-types
  </a>
  
    <nav class="md-nav" aria-label="Advanced uses of self-types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#restricted-methods-in-generic-classes" class="md-nav__link">
    Restricted methods in generic classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixin-classes" class="md-nav__link">
    Mixin classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#precise-typing-of-alternative-constructors" class="md-nav__link">
    Precise typing of alternative constructors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typing-asyncawait" class="md-nav__link">
    Typing async/await
  </a>
  
    <nav class="md-nav" aria-label="Typing async/await">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-iterators" class="md-nav__link">
    Asynchronous iterators
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../literal_and_enum/" class="md-nav__link">
        类型系统参考-文字类型和枚举
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../typeddict/" class="md-nav__link">
        类型系统参考-类型字典
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../final_names_methods_classes/" class="md-nav__link">
        类型系统参考-最终名称、方法和类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metaclasses/" class="md-nav__link">
        类型系统参考-元类
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../http/">HTTP</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          HTTP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/internet_protocol_suite_part_i/" class="md-nav__link">
        互联网协议入门（一）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/internet_protocol_suite_part_ii/" class="md-nav__link">
        互联网协议入门（二）
      </a>
    </li>
  

            
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/restapi/" class="md-nav__link">
        Restful API 设计指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/restapibsetp/" class="md-nav__link">
        RESTful API 最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/http-referer/" class="md-nav__link">
        HTTP Referer 教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/https/" class="md-nav__link">
        HTTPS 升级指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Git
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Git
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-branch-manage/" class="md-nav__link">
        Git分支管理策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-remote/" class="md-nav__link">
        Git远程操作详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-use-process/" class="md-nav__link">
        Git 使用规范流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-cheat-sheet/" class="md-nav__link">
        常用 Git 命令清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-work-flow/" class="md-nav__link">
        Git 协作流程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../xml/" class="md-nav__link">
        xml
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          系统设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          系统设计
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sysdesign/perm_design/" class="md-nav__link">
        权限系统的设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#aaa" class="md-nav__link">
    aaa
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-noreturn-type" class="md-nav__link">
    The NoReturn type
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#newtypes" class="md-nav__link">
    NewTypes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-overloading" class="md-nav__link">
    Function overloading
  </a>
  
    <nav class="md-nav" aria-label="Function overloading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-behavior" class="md-nav__link">
    Runtime behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-calls-to-overloads" class="md-nav__link">
    Type checking calls to overloads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-the-variants" class="md-nav__link">
    Type checking the variants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-checking-the-implementation" class="md-nav__link">
    Type checking the implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conditional-overloads" class="md-nav__link">
    Conditional overloads
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-uses-of-self-types" class="md-nav__link">
    Advanced uses of self-types
  </a>
  
    <nav class="md-nav" aria-label="Advanced uses of self-types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#restricted-methods-in-generic-classes" class="md-nav__link">
    Restricted methods in generic classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixin-classes" class="md-nav__link">
    Mixin classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#precise-typing-of-alternative-constructors" class="md-nav__link">
    Precise typing of alternative constructors
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typing-asyncawait" class="md-nav__link">
    Typing async/await
  </a>
  
    <nav class="md-nav" aria-label="Typing async/await">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#asynchronous-iterators" class="md-nav__link">
    Asynchronous iterators
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="更多类型">更多类型<a class="headerlink" href="#更多类型" title="Permanent link">&para;</a></h1>
<h2 id="aaa">aaa<a class="headerlink" href="#aaa" title="Permanent link">&para;</a></h2>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>本节介绍了一些其他类型，包括 <a href="https://docs.python.org/3/library/typing.html#typing.NoReturn"><code>typing.NoReturn</code></a>、[<code>typing.NewType</code>]( https://docs.python.org/3/library/typing.html#typing.NewType），以及异步代码的类型。 它还讨论了如何使用重载为函数提供更精确的类型。 所有这些仅在特定情况下有用，因此请随意跳过本节，当您需要其中一些时再回来。</p>
<p>以下是本文所涵盖内容的快速摘要：</p>
<ul>
<li><a href="https://docs.python.org/3/library/typing.html#typing.NoReturn"><code>typing.NoReturn</code></a> 让您告诉 mypy 函数永远不会正常返回。</li>
<li><a href="https://docs.python.org/3/library/typing.html#typing.NewType"><code>typing.NewType</code></a> 允许您定义类型的变体，该变体被 mypy 视为单独的类型，但在运行时与原始类型相同。 例如，您可以将 <code>UserId</code> 作为 <code>int</code> 的变体，它在运行时只是一个<code>int</code>。</li>
<li><a href="https://docs.python.org/3/library/typing.html#typing.overload"><code>typing.overload</code></a> 让您定义一个可以接受多个不同签名的函数。 如果您需要对参数和返回类型之间的关系进行编码，而这种关系很难正常表达，那么这非常有用。</li>
<li>异步类型允许您使用 <code>async</code> 和 <code>await</code> 的同时支持检查编码类型。</li>
</ul>
</div>
<div class="tabbed-block">
<p><strong>More types</strong></p>
<p>This section introduces a few additional kinds of types, including <a href="https://docs.python.org/3/library/typing.html#typing.NoReturn"><code>typing.NoReturn</code></a>, <a href="https://docs.python.org/3/library/typing.html#typing.NewType"><code>typing.NewType</code></a>, and types for async code. It also discusses how to give functions more precise types using overloads. All of these are only situationally useful, so feel free to skip this section and come back when you have a need for some of them.</p>
<p>Here's a quick summary of what's covered here:</p>
<ul>
<li><a href="https://docs.python.org/3/library/typing.html#typing.NoReturn"><code>typing.NoReturn</code></a> lets you tell mypy that a function never returns normally.</li>
<li><a href="https://docs.python.org/3/library/typing.html#typing.NewType"><code>typing.NewType</code></a> lets you define a variant of a type that is treated as a separate type by mypy but is identical to the original type at runtime. For example, you can have <code>UserId</code> as a variant of <code>int</code> that is just an <code>int</code> at runtime.</li>
<li><a href="https://docs.python.org/3/library/typing.html#typing.overload"><code>typing.overload</code></a> lets you define a function that can accept multiple distinct signatures. This is useful if you need to encode a relationship between the arguments and the return type that would be difficult to express normally.</li>
<li>Async types let you type check programs using <code>async</code> and <code>await</code>.</li>
</ul>
</div>
</div>
</div>
<h2 id="the-noreturn-type">The NoReturn type<a class="headerlink" href="#the-noreturn-type" title="Permanent link">&para;</a></h2>
<p>Mypy provides support for functions that never return. For
example, a function that unconditionally raises an exception:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>

<span class="k">def</span> <span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;no way&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Mypy will ensure that functions annotated as returning {py:data}<code>~typing.NoReturn</code>
truly never return, either implicitly or explicitly. Mypy will also
recognize that the code after calls to such functions is unreachable
and will behave accordingly:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">stop</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;whatever works&#39;</span>  <span class="c1"># No error in an unreachable block</span>
</code></pre></div>
<p>In earlier Python versions you need to install <code>typing_extensions</code> using
pip to use {py:data}<code>~typing.NoReturn</code> in your code. Python 3 command line:</p>
<div class="highlight"><pre><span></span><code>python3 -m pip install --upgrade typing-extensions
</code></pre></div>
<p>(newtypes)=</p>
<h2 id="newtypes">NewTypes<a class="headerlink" href="#newtypes" title="Permanent link">&para;</a></h2>
<p>There are situations where you may want to avoid programming errors by
creating simple derived classes that are only used to distinguish
certain values from base class instances. Example:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">UserId</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">get_by_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">UserId</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<p>However, this approach introduces some runtime overhead. To avoid this, the typing
module provides a helper object {py:func}<code>NewType &lt;typing.NewType&gt;</code> that creates simple unique types with
almost zero runtime overhead. Mypy will treat the statement
<code>Derived = NewType('Derived', Base)</code> as being roughly equivalent to the following
definition:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Derived</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_x</span><span class="p">:</span> <span class="n">Base</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
</code></pre></div>
<p>However, at runtime, <code>NewType('Derived', Base)</code> will return a dummy callable that
simply returns its argument:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">Derived</span><span class="p">(</span><span class="n">_x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_x</span>
</code></pre></div>
<p>Mypy will require explicit casts from <code>int</code> where <code>UserId</code> is expected, while
implicitly casting from <code>UserId</code> where <code>int</code> is expected. Examples:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NewType</span>

<span class="n">UserId</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;UserId&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">name_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">UserId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="o">...</span>

<span class="n">UserId</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>          <span class="c1"># Fails type check</span>

<span class="n">name_by_id</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>          <span class="c1"># Fails type check</span>
<span class="n">name_by_id</span><span class="p">(</span><span class="n">UserId</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>  <span class="c1"># OK</span>

<span class="n">num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">UserId</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>{py:func}<code>NewType &lt;typing.NewType&gt;</code> accepts exactly two arguments. The first argument must be a string literal
containing the name of the new type and must equal the name of the variable to which the new
type is assigned. The second argument must be a properly subclassable class, i.e.,
not a type construct like {py:data}<code>~typing.Union</code>, etc.</p>
<p>The callable returned by {py:func}<code>NewType &lt;typing.NewType&gt;</code> accepts only one argument; this is equivalent to
supporting only one constructor accepting an instance of the base class (see above).
Example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NewType</span>

<span class="k">class</span> <span class="nc">PacketId</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">major</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_major</span> <span class="o">=</span> <span class="n">major</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minor</span> <span class="o">=</span> <span class="n">minor</span>

<span class="n">TcpPacketId</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;TcpPacketId&#39;</span><span class="p">,</span> <span class="n">PacketId</span><span class="p">)</span>

<span class="n">packet</span> <span class="o">=</span> <span class="n">PacketId</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">tcp_packet</span> <span class="o">=</span> <span class="n">TcpPacketId</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>  <span class="c1"># OK</span>

<span class="n">tcp_packet</span> <span class="o">=</span> <span class="n">TcpPacketId</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Fails in type checker and at runtime</span>
</code></pre></div>
<p>You cannot use {py:func}<code>isinstance</code> or {py:func}<code>issubclass</code> on the object returned by
{py:func}<code>~typing.NewType</code>, nor can you subclass an object returned by {py:func}<code>~typing.NewType</code>.</p>
<p>:::{note}
Unlike type aliases, {py:func}<code>NewType &lt;typing.NewType&gt;</code> will create an entirely new and
unique type when used. The intended purpose of {py:func}<code>NewType &lt;typing.NewType&gt;</code> is to help you
detect cases where you accidentally mixed together the old base type and the
new derived type.</p>
<p>For example, the following will successfully typecheck when using type
aliases:</p>
<div class="highlight"><pre><span></span><code><span class="n">UserId</span> <span class="o">=</span> <span class="nb">int</span>

<span class="k">def</span> <span class="nf">name_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">UserId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="o">...</span>

<span class="n">name_by_id</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># ints and UserId are synonymous</span>
</code></pre></div>
<p>But a similar example using {py:func}<code>NewType &lt;typing.NewType&gt;</code> will not typecheck:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NewType</span>

<span class="n">UserId</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;UserId&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">name_by_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">UserId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="o">...</span>

<span class="n">name_by_id</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># int is not the same as UserId</span>
</code></pre></div>
<p>:::</p>
<p>(function-overloading)=</p>
<h2 id="function-overloading">Function overloading<a class="headerlink" href="#function-overloading" title="Permanent link">&para;</a></h2>
<p>Sometimes the arguments and types in a function depend on each other
in ways that can't be captured with a {py:data}<code>~typing.Union</code>. For example, suppose
we want to write a function that can accept x-y coordinates. If we pass
in just a single x-y coordinate, we return a <code>ClickEvent</code> object. However,
if we pass in two x-y coordinates, we return a <code>DragEvent</code> object.</p>
<p>Our first attempt at writing this function might look like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">def</span> <span class="nf">mouse_event</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">x2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">y2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ClickEvent</span><span class="p">,</span> <span class="n">DragEvent</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ClickEvent</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DragEvent</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad arguments&quot;</span><span class="p">)</span>
</code></pre></div>
<p>While this function signature works, it's too loose: it implies <code>mouse_event</code>
could return either object regardless of the number of arguments
we pass in. It also does not prohibit a caller from passing in the wrong
number of ints: mypy would treat calls like <code>mouse_event(1, 2, 20)</code> as being
valid, for example.</p>
<p>We can do better by using {pep}<code>overloading &lt;484#function-method-overloading&gt;</code>
which lets us give the same function multiple type annotations (signatures)
to more accurately describe the function's behavior:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">overload</span>

<span class="c1"># Overload *variants* for &#39;mouse_event&#39;.</span>
<span class="c1"># These variants give extra information to the type checker.</span>
<span class="c1"># They are ignored at runtime.</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">mouse_event</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClickEvent</span><span class="p">:</span> <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">mouse_event</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DragEvent</span><span class="p">:</span> <span class="o">...</span>

<span class="c1"># The actual *implementation* of &#39;mouse_event&#39;.</span>
<span class="c1"># The implementation contains the actual runtime logic.</span>
<span class="c1">#</span>
<span class="c1"># It may or may not have type hints. If it does, mypy</span>
<span class="c1"># will check the body of the implementation against the</span>
<span class="c1"># type hints.</span>
<span class="c1">#</span>
<span class="c1"># Mypy will also check and make sure the signature is</span>
<span class="c1"># consistent with the provided variants.</span>

<span class="k">def</span> <span class="nf">mouse_event</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">y1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">x2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">y2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">ClickEvent</span><span class="p">,</span> <span class="n">DragEvent</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ClickEvent</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DragEvent</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Bad arguments&quot;</span><span class="p">)</span>
</code></pre></div>
<p>This allows mypy to understand calls to <code>mouse_event</code> much more precisely.
For example, mypy will understand that <code>mouse_event(5, 25)</code> will
always have a return type of <code>ClickEvent</code> and will report errors for
calls like <code>mouse_event(5, 25, 2)</code>.</p>
<p>As another example, suppose we want to write a custom container class that
implements the {py:meth}<code>__getitem__ &lt;object.__getitem__&gt;</code> method (<code>[]</code> bracket indexing). If this
method receives an integer we return a single item. If it receives a
<code>slice</code>, we return a {py:class}<code>~typing.Sequence</code> of items.</p>
<p>We can precisely encode this relationship between the argument and the
return type by using overloads like so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">overload</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyList</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">slice</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">slice</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">T</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># Return a T here</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="c1"># Return a sequence of Ts here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>:::{note}
If you just need to constrain a type variable to certain types or
subtypes, you can use a {ref}<code>value restriction
&lt;type-variable-value-restriction&gt;</code>.
:::</p>
<p>The default values of a function's arguments don't affect its signature -- only
the absence or presence of a default value does. So in order to reduce
redundancy, it's possible to replace default values in overload definitions with
<code>...</code> as a placeholder:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">M</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">model_or_pk</span><span class="p">:</span> <span class="n">M</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span><span class="p">:</span> <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">model_or_pk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">model_or_pk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">M</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">M</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>
</code></pre></div>
<h3 id="runtime-behavior">Runtime behavior<a class="headerlink" href="#runtime-behavior" title="Permanent link">&para;</a></h3>
<p>An overloaded function must consist of two or more overload <em>variants</em>
followed by an <em>implementation</em>. The variants and the implementations
must be adjacent in the code: think of them as one indivisible unit.</p>
<p>The variant bodies must all be empty; only the implementation is allowed
to contain code. This is because at runtime, the variants are completely
ignored: they're overridden by the final implementation function.</p>
<p>This means that an overloaded function is still an ordinary Python
function! There is no automatic dispatch handling and you must manually
handle the different types in the implementation (e.g. by using
<code>if</code> statements and {py:func}<code>isinstance &lt;isinstance&gt;</code> checks).</p>
<p>If you are adding an overload within a stub file, the implementation
function should be omitted: stubs do not contain runtime logic.</p>
<p>:::{note}
While we can leave the variant body empty using the <code>pass</code> keyword,
the more common convention is to instead use the ellipsis (<code>...</code>) literal.
:::</p>
<h3 id="type-checking-calls-to-overloads">Type checking calls to overloads<a class="headerlink" href="#type-checking-calls-to-overloads" title="Permanent link">&para;</a></h3>
<p>When you call an overloaded function, mypy will infer the correct return
type by picking the best matching variant, after taking into consideration
both the argument types and arity. However, a call is never type
checked against the implementation. This is why mypy will report calls
like <code>mouse_event(5, 25, 3)</code> as being invalid even though it matches the
implementation signature.</p>
<p>If there are multiple equally good matching variants, mypy will select
the variant that was defined first. For example, consider the following
program:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># For Python 3.8 and below you must use `typing.List` instead of `list`. e.g.</span>
<span class="c1"># from typing import List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Do int specific code</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Do str-specific code</span>

<span class="c1"># What is the type of &#39;output&#39;? float or str?</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">([])</span>
</code></pre></div>
<p>The <code>summarize([])</code> call matches both variants: an empty list could
be either a <code>list[int]</code> or a <code>list[str]</code>. In this case, mypy
will break the tie by picking the first matching variant: <code>output</code>
will have an inferred type of <code>float</code>. The implementor is responsible
for making sure <code>summarize</code> breaks ties in the same way at runtime.</p>
<p>However, there are two exceptions to the "pick the first match" rule.
First, if multiple variants match due to an argument being of type
<code>Any</code>, mypy will make the inferred type also be <code>Any</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">dynamic_var</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">some_dynamic_function</span><span class="p">()</span>

<span class="c1"># output2 is of type &#39;Any&#39;</span>
<span class="n">output2</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">dynamic_var</span><span class="p">)</span>
</code></pre></div>
<p>Second, if multiple variants match due to one or more of the arguments
being a union, mypy will make the inferred type be the union of the
matching variant returns:</p>
<div class="highlight"><pre><span></span><code><span class="n">some_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="c1"># output3 is of type &#39;Union[float, str]&#39;</span>
<span class="n">output3</span> <span class="o">=</span> <span class="n">summarize</span><span class="p">(</span><span class="n">some_list</span><span class="p">)</span>
</code></pre></div>
<p>:::{note}
Due to the "pick the first match" rule, changing the order of your
overload variants can change how mypy type checks your program.</p>
<p>To minimize potential issues, we recommend that you:</p>
<ol>
<li>Make sure your overload variants are listed in the same order as
   the runtime checks (e.g. {py:func}<code>isinstance &lt;isinstance&gt;</code> checks) in your implementation.</li>
<li>Order your variants and runtime checks from most to least specific.
   (See the following section for an example).
:::</li>
</ol>
<h3 id="type-checking-the-variants">Type checking the variants<a class="headerlink" href="#type-checking-the-variants" title="Permanent link">&para;</a></h3>
<p>Mypy will perform several checks on your overload variant definitions
to ensure they behave as expected. First, mypy will check and make sure
that no overload variant is shadowing a subsequent one. For example,
consider the following function which adds together two <code>Expression</code>
objects, and contains a special-case to handle receiving two <code>Literal</code>
types:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">Union</span>

<span class="k">class</span> <span class="nc">Expression</span><span class="p">:</span>
    <span class="c1"># ...snip...</span>

<span class="k">class</span> <span class="nc">Literal</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="c1"># ...snip...</span>

<span class="c1"># Warning -- the first overload variant shadows the second!</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Literal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
    <span class="c1"># ...snip...</span>
</code></pre></div>
<p>While this code snippet is technically type-safe, it does contain an
anti-pattern: the second variant will never be selected! If we try calling
<code>add(Literal(3), Literal(4))</code>, mypy will always pick the first variant
and evaluate the function call to be of type <code>Expression</code>, not <code>Literal</code>.
This is because <code>Literal</code> is a subtype of <code>Expression</code>, which means
the "pick the first match" rule will always halt after considering the
first overload.</p>
<p>Because having an overload variant that can never be matched is almost
certainly a mistake, mypy will report an error. To fix the error, we can
either 1) delete the second overload or 2) swap the order of the overloads:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Everything is ok now -- the variants are correctly ordered</span>
<span class="c1"># from most to least specific.</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Literal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span>
    <span class="c1"># ...snip...</span>
</code></pre></div>
<p>Mypy will also type check the different variants and flag any overloads
that have inherently unsafely overlapping variants. For example, consider
the following unsafe overload definition:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span><span class="p">,</span> <span class="n">Union</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">unsafe_func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">unsafe_func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">unsafe_func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">42</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;some string&quot;</span>
</code></pre></div>
<p>On the surface, this function definition appears to be fine. However, it will
result in a discrepancy between the inferred type and the actual runtime type
when we try using it like so:</p>
<div class="highlight"><pre><span></span><code><span class="n">some_obj</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">unsafe_func</span><span class="p">(</span><span class="n">some_obj</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; danger danger&quot;</span>  <span class="c1"># Type checks, yet crashes at runtime!</span>
</code></pre></div>
<p>Since <code>some_obj</code> is of type {py:class}<code>object</code>, mypy will decide that <code>unsafe_func</code>
must return something of type <code>str</code> and concludes the above will type check.
But in reality, <code>unsafe_func</code> will return an int, causing the code to crash
at runtime!</p>
<p>To prevent these kinds of issues, mypy will detect and prohibit inherently unsafely
overlapping overloads on a best-effort basis. Two variants are considered unsafely
overlapping when both of the following are true:</p>
<ol>
<li>All of the arguments of the first variant are compatible with the second.</li>
<li>The return type of the first variant is <em>not</em> compatible with (e.g. is not a
   subtype of) the second.</li>
</ol>
<p>So in this example, the <code>int</code> argument in the first variant is a subtype of
the <code>object</code> argument in the second, yet the <code>int</code> return type is not a subtype of
<code>str</code>. Both conditions are true, so mypy will correctly flag <code>unsafe_func</code> as
being unsafe.</p>
<p>However, mypy will not detect <em>all</em> unsafe uses of overloads. For example,
suppose we modify the above snippet so it calls <code>summarize</code> instead of
<code>unsafe_func</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">some_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">summarize</span><span class="p">(</span><span class="n">some_list</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;danger danger&quot;</span>  <span class="c1"># Type safe, yet crashes at runtime!</span>
</code></pre></div>
<p>We run into a similar issue here. This program type checks if we look just at the
annotations on the overloads. But since <code>summarize(...)</code> is designed to be biased
towards returning a float when it receives an empty list, this program will actually
crash during runtime.</p>
<p>The reason mypy does not flag definitions like <code>summarize</code> as being potentially
unsafe is because if it did, it would be extremely difficult to write a safe
overload. For example, suppose we define an overload with two variants that accept
types <code>A</code> and <code>B</code> respectively. Even if those two types were completely unrelated,
the user could still potentially trigger a runtime error similar to the ones above by
passing in a value of some third type <code>C</code> that inherits from both <code>A</code> and <code>B</code>.</p>
<p>Thankfully, these types of situations are relatively rare. What this does mean,
however, is that you should exercise caution when designing or using an overloaded
function that can potentially receive values that are an instance of two seemingly
unrelated types.</p>
<h3 id="type-checking-the-implementation">Type checking the implementation<a class="headerlink" href="#type-checking-the-implementation" title="Permanent link">&para;</a></h3>
<p>The body of an implementation is type-checked against the
type hints provided on the implementation. For example, in the
<code>MyList</code> example up above, the code in the body is checked with
argument list <code>index: Union[int, slice]</code> and a return type of
<code>Union[T, Sequence[T]]</code>. If there are no annotations on the
implementation, then the body is not type checked. If you want to
force mypy to check the body anyways, use the {option}<code>--check-untyped-defs &lt;mypy --check-untyped-defs&gt;</code>
flag ({ref}<code>more details here &lt;untyped-definitions-and-calls&gt;</code>).</p>
<p>The variants must also also be compatible with the implementation
type hints. In the <code>MyList</code> example, mypy will check that the
parameter type <code>int</code> and the return type <code>T</code> are compatible with
<code>Union[int, slice]</code> and <code>Union[T, Sequence]</code> for the
first variant. For the second variant it verifies the parameter
type <code>slice</code> and the return type <code>Sequence[T]</code> are compatible
with <code>Union[int, slice]</code> and <code>Union[T, Sequence]</code>.</p>
<p>:::{note}
The overload semantics documented above are new as of mypy 0.620.</p>
<p>Previously, mypy used to perform type erasure on all overload variants. For
example, the <code>summarize</code> example from the previous section used to be
illegal because <code>list[str]</code> and <code>list[int]</code> both erased to just <code>list[Any]</code>.
This restriction was removed in mypy 0.620.</p>
<p>Mypy also previously used to select the best matching variant using a different
algorithm. If this algorithm failed to find a match, it would default to returning
<code>Any</code>. The new algorithm uses the "pick the first match" rule and will fall back
to returning <code>Any</code> only if the input arguments also contain <code>Any</code>.
:::</p>
<h3 id="conditional-overloads">Conditional overloads<a class="headerlink" href="#conditional-overloads" title="Permanent link">&para;</a></h3>
<p>Sometimes it is useful to define overloads conditionally.
Common use cases include types that are unavailable at runtime or that
only exist in a certain Python version. All existing overload rules still apply.
For example, there must be at least two overloads.</p>
<p>:::{note}
Mypy can only infer a limited number of conditions.
Supported ones currently include {py:data}<code>~typing.TYPE_CHECKING</code>, <code>MYPY</code>,
{ref}<code>version_and_platform_checks</code>, {option}<code>--always-true &lt;mypy --always-true&gt;</code>,
and {option}<code>--always-false &lt;mypy --always-false&gt;</code> values.
:::</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">A</span><span class="p">:</span> <span class="o">...</span>
    <span class="k">class</span> <span class="nc">B</span><span class="p">:</span> <span class="o">...</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">B</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">var</span>


<span class="n">reveal_type</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">A</span><span class="p">()))</span>  <span class="c1"># Revealed type is &quot;A&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># flags: --python-version 3.10</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span> <span class="o">...</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">:</span> <span class="o">...</span>
<span class="k">class</span> <span class="nc">C</span><span class="p">:</span> <span class="o">...</span>
<span class="k">class</span> <span class="nc">D</span><span class="p">:</span> <span class="o">...</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span> <span class="o">...</span>

<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">B</span><span class="p">:</span> <span class="o">...</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">C</span><span class="p">:</span> <span class="o">...</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">D</span><span class="p">:</span> <span class="o">...</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">var</span>


<span class="n">reveal_type</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">B</span><span class="p">()))</span>  <span class="c1"># Revealed type is &quot;B&quot;</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">C</span><span class="p">()))</span>  <span class="c1"># No overload variant of &quot;func&quot; matches argument type &quot;C&quot;</span>
    <span class="c1"># Possible overload variants:</span>
    <span class="c1">#     def func(var: B) -&gt; B</span>
    <span class="c1">#     def func(var: D) -&gt; D</span>
    <span class="c1"># Revealed type is &quot;Any&quot;</span>
</code></pre></div>
<p>:::{note}
In the last example, mypy is executed with
{option}<code>--python-version 3.10 &lt;mypy --python-version&gt;</code>.
Therefore, the condition <code>sys.version_info &gt;= (3, 10)</code> will match and
the overload for <code>B</code> will be added.
The overloads for <code>A</code> and <code>C</code> are ignored!
The overload for <code>D</code> is not defined conditionally and thus is also added.
:::</p>
<p>When mypy cannot infer a condition to be always <code>True</code> or always <code>False</code>,
an error is emitted.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">:</span> <span class="o">...</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">:</span> <span class="o">...</span>


<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">bool_var</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">bool_var</span><span class="p">:</span>  <span class="c1"># Condition can&#39;t be inferred, unable to merge overloads</span>
        <span class="nd">@overload</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">A</span><span class="p">:</span> <span class="o">...</span>

        <span class="nd">@overload</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">B</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>

    <span class="n">reveal_type</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">A</span><span class="p">()))</span>  <span class="c1"># Revealed type is &quot;Any&quot;</span>
</code></pre></div>
<p>(advanced-self)=</p>
<h2 id="advanced-uses-of-self-types">Advanced uses of self-types<a class="headerlink" href="#advanced-uses-of-self-types" title="Permanent link">&para;</a></h2>
<p>Normally, mypy doesn't require annotations for the first arguments of instance and
class methods. However, they may be needed to have more precise static typing
for certain programming patterns.</p>
<h3 id="restricted-methods-in-generic-classes">Restricted methods in generic classes<a class="headerlink" href="#restricted-methods-in-generic-classes" title="Permanent link">&para;</a></h3>
<p>In generic classes some methods may be allowed to be called only
for certain values of type arguments:</p>
<div class="highlight"><pre><span></span><code><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">T</span>
    <span class="k">def</span> <span class="nf">uppercase_item</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Tag</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">label</span><span class="p">(</span><span class="n">ti</span><span class="p">:</span> <span class="n">Tag</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ts</span><span class="p">:</span> <span class="n">Tag</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ti</span><span class="o">.</span><span class="n">uppercase_item</span><span class="p">()</span>  <span class="c1"># E: Invalid self argument &quot;Tag[int]&quot; to attribute function</span>
                         <span class="c1"># &quot;uppercase_item&quot; with type &quot;Callable[[Tag[str]], str]&quot;</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">uppercase_item</span><span class="p">()</span>  <span class="c1"># This is OK</span>
</code></pre></div>
<p>This pattern also allows matching on nested types in situations where the type
argument is itself generic:</p>
<div class="highlight"><pre><span></span><code><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">covariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">Storage</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
     <span class="k">def</span> <span class="nf">first_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Storage</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">S</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">S</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

 <span class="n">page</span><span class="p">:</span> <span class="n">Storage</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
 <span class="n">page</span><span class="o">.</span><span class="n">first_chunk</span><span class="p">()</span>  <span class="c1"># OK, type is &quot;str&quot;</span>

 <span class="n">Storage</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">first_chunk</span><span class="p">()</span>  <span class="c1"># Error: Invalid self argument &quot;Storage[int]&quot; to attribute function</span>
                           <span class="c1"># &quot;first_chunk&quot; with type &quot;Callable[[Storage[Sequence[S]]], S]&quot;</span>
</code></pre></div>
<p>Finally, one can use overloads on self-type to express precise types of
some tricky methods:</p>
<div class="highlight"><pre><span></span><code><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Tag</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">],</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span>
        <span class="k">return</span> <span class="n">converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">)</span>
</code></pre></div>
<p>In particular, an {py:meth}<code>~object.__init__</code> method overloaded on self-type
may be useful to annotate generic class constructors where type arguments
depend on constructor parameters in a non-trivial way, see e.g. {py:class}<code>~subprocess.Popen</code>.</p>
<h3 id="mixin-classes">Mixin classes<a class="headerlink" href="#mixin-classes" title="Permanent link">&para;</a></h3>
<p>Using host class protocol as a self-type in mixin methods allows
more code re-usability for static typing of mixin classes. For example,
one can define a protocol that defines common functionality for
host classes instead of adding required abstract methods to every mixin:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Lockable</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lock</span><span class="p">:</span> <span class="o">...</span>

<span class="k">class</span> <span class="nc">AtomicCloseMixin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">atomic_close</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Lockable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># perform actions</span>

<span class="k">class</span> <span class="nc">AtomicOpenMixin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">atomic_open</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Lockable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="c1"># perform actions</span>

<span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="n">AtomicCloseMixin</span><span class="p">,</span> <span class="n">AtomicOpenMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Bad</span><span class="p">(</span><span class="n">AtomicCloseMixin</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">File</span><span class="p">()</span>
<span class="n">b</span><span class="p">:</span> <span class="n">Bad</span>
<span class="n">f</span><span class="o">.</span><span class="n">atomic_close</span><span class="p">()</span>  <span class="c1"># OK</span>
<span class="n">b</span><span class="o">.</span><span class="n">atomic_close</span><span class="p">()</span>  <span class="c1"># Error: Invalid self type for &quot;atomic_close&quot;</span>
</code></pre></div>
<p>Note that the explicit self-type is <em>required</em> to be a protocol whenever it
is not a supertype of the current class. In this case mypy will check the validity
of the self-type only at the call site.</p>
<h3 id="precise-typing-of-alternative-constructors">Precise typing of alternative constructors<a class="headerlink" href="#precise-typing-of-alternative-constructors" title="Permanent link">&para;</a></h3>
<p>Some classes may define alternative constructors. If these
classes are generic, self-type allows giving them precise signatures:</p>
<div class="highlight"><pre><span></span><code><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;Base[T]&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_pair</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Q</span><span class="p">],</span> <span class="n">item</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Q</span><span class="p">,</span> <span class="n">Q</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="bp">cls</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Sub</span><span class="p">(</span><span class="n">Base</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
    <span class="o">...</span>

<span class="n">pair</span> <span class="o">=</span> <span class="n">Sub</span><span class="o">.</span><span class="n">make_pair</span><span class="p">(</span><span class="s1">&#39;yes&#39;</span><span class="p">)</span>  <span class="c1"># Type is &quot;tuple[Sub[str], Sub[str]]&quot;</span>
<span class="n">bad</span> <span class="o">=</span> <span class="n">Sub</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">.</span><span class="n">make_pair</span><span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">)</span>  <span class="c1"># Error: Argument 1 to &quot;make_pair&quot; of &quot;Base&quot;</span>
                                <span class="c1"># has incompatible type &quot;str&quot;; expected &quot;int&quot;</span>
</code></pre></div>
<p>(async-and-await)=</p>
<h2 id="typing-asyncawait">Typing async/await<a class="headerlink" href="#typing-asyncawait" title="Permanent link">&para;</a></h2>
<p>Mypy lets you type coroutines that use the <code>async/await</code> syntax.
For more information regarding coroutines, see {pep}<code>492</code> and the
<a href="https://docs.python.org/3/library/asyncio.html">asyncio documentation</a>.</p>
<p>Functions defined using <code>async def</code> are typed similar to normal functions.
The return type annotation should be the same as the type of the value you
expect to get back when <code>await</code>-ing the coroutine.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">format_string</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;T-minus </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">)&#39;</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">my_str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">format_string</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>  <span class="c1"># type is inferred to be str</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">my_str</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s2">&quot;Blastoff!&quot;</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">countdown</span><span class="p">(</span><span class="s2">&quot;Millennium Falcon&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</code></pre></div>
<p>The result of calling an <code>async def</code> function <em>without awaiting</em> will
automatically be inferred to be a value of type
{py:class}<code>Coroutine[Any, Any, T] &lt;typing.Coroutine&gt;</code>, which is a subtype of
{py:class}<code>Awaitable[T] &lt;typing.Awaitable&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">my_coroutine</span> <span class="o">=</span> <span class="n">countdown</span><span class="p">(</span><span class="s2">&quot;Millennium Falcon&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">my_coroutine</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;typing.Coroutine[Any, Any, builtins.str]&quot;</span>
</code></pre></div>
<p>(async-iterators)=</p>
<h3 id="asynchronous-iterators">Asynchronous iterators<a class="headerlink" href="#asynchronous-iterators" title="Permanent link">&para;</a></h3>
<p>If you have an asynchronous iterator, you can use the
{py:class}<code>~typing.AsyncIterator</code> type in your annotations:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">AsyncIterator</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="k">class</span> <span class="nc">arange</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">step</span>

    <span class="k">def</span> <span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">run_countdown</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">countdown</span><span class="p">:</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">countdown</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;T-minus </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Blastoff!&quot;</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_countdown</span><span class="p">(</span><span class="s2">&quot;Serenity&quot;</span><span class="p">,</span> <span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div>
<p>Async generators (introduced in {pep}<code>525</code>) are an easy way to create
async iterators:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncGenerator</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="c1"># Could also type this as returning AsyncIterator[int]</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">arange</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">start</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">step</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">current</span>
        <span class="n">current</span> <span class="o">+=</span> <span class="n">step</span>

<span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_countdown</span><span class="p">(</span><span class="s2">&quot;Battlestar Galactica&quot;</span><span class="p">,</span> <span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</code></pre></div>
<p>One common confusion is that the presence of a <code>yield</code> statement in an
<code>async def</code> function has an effect on the type of the function:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">arange</span><span class="p">(</span><span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="c1"># When called, arange gives you an async iterator</span>
    <span class="c1"># Equivalent to Callable[[int], AsyncIterator[int]]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">coroutine</span><span class="p">(</span><span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="c1"># When called, coroutine gives you something you can await to get an async iterator</span>
    <span class="c1"># Equivalent to Callable[[int], Coroutine[Any, Any, AsyncIterator[int]]]</span>
    <span class="k">return</span> <span class="n">arange</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># Revealed type is &quot;typing.AsyncIterator[builtins.int]&quot;</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">coroutine</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># Revealed type is &quot;typing.Coroutine[Any, Any, typing.AsyncIterator[builtins.int]]&quot;</span>

    <span class="k">await</span> <span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Error: Incompatible types in &quot;await&quot; (actual type &quot;AsyncIterator[int]&quot;, expected type &quot;Awaitable[Any]&quot;)</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="k">await</span> <span class="n">coroutine</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># Revealed type is &quot;typing.AsyncIterator[builtins.int]&quot;</span>
</code></pre></div>
<p>This can sometimes come up when trying to define base classes, Protocols or overloads:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncIterator</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">overload</span>

<span class="k">class</span> <span class="nc">LauncherIncorrect</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="c1"># Because launch does not have yield, this has type</span>
    <span class="c1"># Callable[[], Coroutine[Any, Any, AsyncIterator[int]]]</span>
    <span class="c1"># instead of</span>
    <span class="c1"># Callable[[], AsyncIterator[int]]</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LauncherCorrect</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="k">class</span> <span class="nc">LauncherAlsoCorrect</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">yield</span> <span class="mi">0</span>

<span class="c1"># The type of the overloads is independent of the implementation.</span>
<span class="c1"># In particular, their type is not affected by whether or not the</span>
<span class="c1"># implementation contains a `yield`.</span>
<span class="c1"># Use of `def`` makes it clear the type is Callable[..., AsyncIterator[int]],</span>
<span class="c1"># whereas with `async def` it would be Callable[..., Coroutine[Any, Any, AsyncIterator[int]]]</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span> <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span> <span class="o">...</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="c1"># The implementation of launch is an async generator and contains a yield</span>
    <span class="k">yield</span> <span class="mi">0</span>
</code></pre></div>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年7月6日</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年7月6日</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "toc.follow"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c2be25ad.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>