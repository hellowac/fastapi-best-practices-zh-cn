
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastApi 最佳实践-中文版">
      
      
      
      
        <link rel="prev" href="../dynamic_typing/">
      
      
        <link rel="next" href="../duck_type_compatibility/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.12">
    
    
      
        <title>类型系统参考-类型收缩 - FastApi 最佳实践-中文版</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.85bb2934.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#类型收缩" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="FastApi 最佳实践-中文版" class="md-header__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastApi 最佳实践-中文版
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              类型系统参考-类型收缩
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      最佳实践
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../raw_en/" class="md-tabs__link">
      英文原版
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../asyncio/asyncio/" class="md-tabs__link">
        Asyncio
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../cheat_sheet_py3/" class="md-tabs__link md-tabs__link--active">
        mypy
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../http/internet_protocol_suite_part_i/" class="md-tabs__link">
        HTTP
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../git/git-branch-manage/" class="md-tabs__link">
        Git
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../sysdesign/perm_design/" class="md-tabs__link">
        系统设计
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../about/" class="md-tabs__link">
      关于
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FastApi 最佳实践-中文版" class="md-nav__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FastApi 最佳实践-中文版
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        最佳实践
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../raw_en/" class="md-nav__link">
        英文原版
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Asyncio
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Asyncio
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/asyncio/" class="md-nav__link">
        中文简单指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/asyncio_en/" class="md-nav__link">
        中英对照指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/runner/" class="md-nav__link">
        Runner运行协程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/task_group/" class="md-nav__link">
        TaskGroup管理协程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/cheat_sheet/" class="md-nav__link">
        语法备忘录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../asyncio/api_mind_map/" class="md-nav__link">
        API思维导图
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          mypy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          mypy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cheat_sheet_py3/" class="md-nav__link">
        类型注解备忘录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../builtin_types/" class="md-nav__link">
        类型系统参考-内置类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../type_inference_type_annotations/" class="md-nav__link">
        类型系统参考-类型推断和类型注解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kind_of_types/" class="md-nav__link">
        类型系统参考-类型种类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../class_basics/" class="md-nav__link">
        类型系统参考-类的基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../annotation_issue_at_runtime/" class="md-nav__link">
        类型系统参考-运行时的注解问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../protocol_and_struct_subtyping/" class="md-nav__link">
        类型系统参考-协议和结构子类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dynamic_typing/" class="md-nav__link">
        类型系统参考-类型收缩
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          类型系统参考-类型收缩
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        类型系统参考-类型收缩
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#type-narrowing-expressions" class="md-nav__link">
    Type narrowing expressions
  </a>
  
    <nav class="md-nav" aria-label="Type narrowing expressions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#issubclass" class="md-nav__link">
    issubclass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callable" class="md-nav__link">
    callable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#casts" class="md-nav__link">
    Casts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-defined-type-guards" class="md-nav__link">
    User-Defined Type Guards
  </a>
  
    <nav class="md-nav" aria-label="User-Defined Type Guards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-typeguards" class="md-nav__link">
    Generic TypeGuards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typeguards-with-parameters" class="md-nav__link">
    Typeguards with parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typeguards-as-methods" class="md-nav__link">
    TypeGuards as methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#assignment-expressions-as-typeguards" class="md-nav__link">
    Assignment expressions as TypeGuards
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../duck_type_compatibility/" class="md-nav__link">
        类型系统参考-鸭子类型兼容
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../stub_files/" class="md-nav__link">
        类型系统参考-存根文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../generics/" class="md-nav__link">
        类型系统参考-泛型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../more_types/" class="md-nav__link">
        类型系统参考-更多类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../literal_and_enum/" class="md-nav__link">
        类型系统参考-文字类型和枚举
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../typeddict/" class="md-nav__link">
        类型系统参考-类型字典
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../final_names_methods_classes/" class="md-nav__link">
        类型系统参考-最终名称、方法和类
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../metaclasses/" class="md-nav__link">
        类型系统参考-元类
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
          
            
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../http/">HTTP</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          HTTP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/internet_protocol_suite_part_i/" class="md-nav__link">
        互联网协议入门（一）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/internet_protocol_suite_part_ii/" class="md-nav__link">
        互联网协议入门（二）
      </a>
    </li>
  

            
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/restapi/" class="md-nav__link">
        Restful API 设计指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/restapibsetp/" class="md-nav__link">
        RESTful API 最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/http-referer/" class="md-nav__link">
        HTTP Referer 教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../http/https/" class="md-nav__link">
        HTTPS 升级指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Git
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Git
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-branch-manage/" class="md-nav__link">
        Git分支管理策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-remote/" class="md-nav__link">
        Git远程操作详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-use-process/" class="md-nav__link">
        Git 使用规范流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-cheat-sheet/" class="md-nav__link">
        常用 Git 命令清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git-work-flow/" class="md-nav__link">
        Git 协作流程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          系统设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          系统设计
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../sysdesign/perm_design/" class="md-nav__link">
        权限系统的设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#type-narrowing-expressions" class="md-nav__link">
    Type narrowing expressions
  </a>
  
    <nav class="md-nav" aria-label="Type narrowing expressions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#issubclass" class="md-nav__link">
    issubclass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callable" class="md-nav__link">
    callable
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#casts" class="md-nav__link">
    Casts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#user-defined-type-guards" class="md-nav__link">
    User-Defined Type Guards
  </a>
  
    <nav class="md-nav" aria-label="User-Defined Type Guards">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-typeguards" class="md-nav__link">
    Generic TypeGuards
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typeguards-with-parameters" class="md-nav__link">
    Typeguards with parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#typeguards-as-methods" class="md-nav__link">
    TypeGuards as methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#assignment-expressions-as-typeguards" class="md-nav__link">
    Assignment expressions as TypeGuards
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="类型收缩">类型收缩<a class="headerlink" href="#类型收缩" title="Permanent link">&para;</a></h1>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>本节专门介绍 mypy 支持的几种类型收缩技术。</p>
<p>类型缩小是指您让类型检查器相信更广泛的类型实际上更具体，例如，<code>Shape</code> 类型的对象实际上是更窄的 <code>Square</code> 类型。</p>
</div>
<div class="tabbed-block">
<p><strong>Type narrowing</strong></p>
<p>This section is dedicated to  several type narrowing techniques which are supported by mypy.</p>
<p>Type narrowing is when you convince a type checker that a broader type is actually more specific, for instance, that an object of type <code>Shape</code> is actually of the narrower type <code>Square</code>.</p>
</div>
</div>
</div>
<h2 id="type-narrowing-expressions">Type narrowing expressions<a class="headerlink" href="#type-narrowing-expressions" title="Permanent link">&para;</a></h2>
<p>The simplest way to narrow a type is to use one of the supported expressions:</p>
<ul>
<li>{py:func}<code>isinstance</code> like in <code>isinstance(obj, float)</code> will narrow <code>obj</code> to have <code>float</code> type</li>
<li>{py:func}<code>issubclass</code> like in <code>issubclass(cls, MyClass)</code> will narrow <code>cls</code> to be <code>Type[MyClass]</code></li>
<li>{py:class}<code>type</code> like in <code>type(obj) is int</code> will narrow <code>obj</code> to have <code>int</code> type</li>
<li>{py:func}<code>callable</code> like in <code>callable(obj)</code> will narrow object to callable type</li>
</ul>
<p>Type narrowing is contextual. For example, based on the condition, mypy will narrow an expression only within an <code>if</code> branch:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Type is narrowed within the ``if`` branch only</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.int&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># Type is narrowed differently within this ``elif`` branch:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.str | builtins.bool&quot;</span>

        <span class="c1"># Subsequent narrowing operations will narrow the type further</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.bool&quot;</span>

    <span class="c1"># Back outside of the ``if`` statement, the type isn&#39;t narrowed:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.object&quot;</span>
</code></pre></div>
<p>Mypy understands the implications <code>return</code> or exception raising can have
for what type an object could be:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># `arg` can&#39;t be `int` at this point:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.str&quot;</span>
</code></pre></div>
<p>We can also use <code>assert</code> to narrow types in the same context:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># Revealed type: &quot;builtins.int&quot;</span>
</code></pre></div>
<p>:::{note}
With {option}<code>--warn-unreachable &lt;mypy --warn-unreachable&gt;</code>
narrowing types to some impossible state will be treated as an error.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># error: Subclass of &quot;int&quot; and &quot;str&quot; cannot exist:</span>
    <span class="c1"># would have incompatible method signatures</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="c1"># error: Statement is unreachable</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;so mypy concludes the assert will always trigger&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Without <code>--warn-unreachable</code> mypy will simply not check code it deems to be
unreachable. See {ref}<code>unreachable</code> for more information.</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.int&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span><span class="p">)</span>  <span class="c1"># Typechecks with `mypy`, but fails in runtime.</span>
</code></pre></div>
<p>:::</p>
<h3 id="issubclass">issubclass<a class="headerlink" href="#issubclass" title="Permanent link">&para;</a></h3>
<p>Mypy can also use {py:func}<code>issubclass</code>
for better type inference when working with types and metaclasses:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyCalcMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>  <span class="c1"># We must use a variable here</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.type&quot;</span>

    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">MyCalcMeta</span><span class="p">):</span>  <span class="c1"># `issubclass(type(o), MyCalcMeta)` won&#39;t work</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Type[MyCalcMeta]&quot;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">calc</span><span class="p">()</span>  <span class="c1"># Okay</span>
</code></pre></div>
<h3 id="callable">callable<a class="headerlink" href="#callable" title="Permanent link">&para;</a></h3>
<p>Mypy knows what types are callable and which ones are not during type checking.
So, we know what <code>callable()</code> will return. For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>

<span class="n">x</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">int</span><span class="p">]</span>

<span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;def () -&gt; builtins.int&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="o">...</span>  <span class="c1"># Will never be executed and will raise error with `--warn-unreachable`</span>
</code></pre></div>
<p><code>callable</code> function can even split <code>Union</code> type
for callable and non-callable parts:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span>

<span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">int</span><span class="p">]]</span>

<span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;def () -&gt; builtins.int&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &quot;builtins.int&quot;</span>
</code></pre></div>
<p>(casts)=</p>
<h2 id="casts">Casts<a class="headerlink" href="#casts" title="Permanent link">&para;</a></h2>
<p>Mypy supports type casts that are usually used to coerce a statically
typed value to a subtype. Unlike languages such as Java or C#,
however, mypy casts are only used as hints for the type checker, and they
don't perform a runtime type check. Use the function {py:func}<code>~typing.cast</code>
to perform a cast:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="n">o</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>  <span class="c1"># OK</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">o</span><span class="p">)</span>  <span class="c1"># OK (cast performs no actual runtime check)</span>
</code></pre></div>
<p>To support runtime checking of casts such as the above, we'd have to check
the types of all list items, which would be very inefficient for large lists.
Casts are used to silence spurious
type checker warnings and give the type checker a little help when it can't
quite understand what is going on.</p>
<p>:::{note}
You can use an assertion if you want to perform an actual runtime check:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">o</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># Error: can&#39;t add &#39;object&#39; and &#39;int&#39;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># OK: type of &#39;o&#39; is &#39;int&#39; here</span>
</code></pre></div>
<p>:::</p>
<p>You don't need a cast for expressions with type <code>Any</code>, or when
assigning to a variable with type <code>Any</code>, as was explained earlier.
You can also use <code>Any</code> as the cast target type -- this lets you perform
any operations on the result. For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Any</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">x</span><span class="o">.</span><span class="n">whatever</span><span class="p">()</span>  <span class="c1"># Type check error</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">whatever</span><span class="p">()</span>  <span class="c1"># Type check OK (runtime error)</span>
</code></pre></div>
<p>(type-guards)=</p>
<h2 id="user-defined-type-guards">User-Defined Type Guards<a class="headerlink" href="#user-defined-type-guards" title="Permanent link">&para;</a></h2>
<p>Mypy supports User-Defined Type Guards ({pep}<code>647</code>).</p>
<p>A type guard is a way for programs to influence conditional
type narrowing employed by a type checker based on runtime checks.</p>
<p>Basically, a <code>TypeGuard</code> is a "smart" alias for a <code>bool</code> type.
Let's have a look at the regular <code>bool</code> example:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Determines whether all objects in the list are strings&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># Reveals list[object]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="c1"># Error: incompatible type</span>
</code></pre></div>
<p>The same example with <code>TypeGuard</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for Python 3.9 and below</span>

<span class="k">def</span> <span class="nf">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determines whether all objects in the list are strings&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func1</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_str_list</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># list[str]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="c1"># ok</span>
</code></pre></div>
<p>How does it work? <code>TypeGuard</code> narrows the first function argument (<code>val</code>)
to the type specified as the first type parameter (<code>list[str]</code>).</p>
<p>:::{note}
Narrowing is
<a href="https://www.python.org/dev/peps/pep-0647/#enforcing-strict-narrowing">not strict</a>.
For example, you can narrow <code>str</code> to <code>int</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p>Note: since strict narrowing is not enforced, it's easy
to break type safety.</p>
<p>However, there are many ways a determined or uninformed developer can
subvert type safety -- most commonly by using cast or Any.
If a Python developer takes the time to learn about and implement
user-defined type guards within their code,
it is safe to assume that they are interested in type safety
and will not write their type guard functions in a way
that will undermine type safety or produce nonsensical results.
:::</p>
<h3 id="generic-typeguards">Generic TypeGuards<a class="headerlink" href="#generic-typeguards" title="Permanent link">&para;</a></h3>
<p><code>TypeGuard</code> can also work with generic types:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_two_element_tuple</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">is_two_element_tuple</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># tuple[str, str]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>  <span class="c1"># tuple[str, ...]</span>
</code></pre></div>
<h3 id="typeguards-with-parameters">Typeguards with parameters<a class="headerlink" href="#typeguards-with-parameters" title="Permanent link">&para;</a></h3>
<p>Type guard functions can accept extra arguments:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_set_of</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>

<span class="n">items</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
<span class="k">if</span> <span class="n">is_set_of</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>  <span class="c1"># set[str]</span>
</code></pre></div>
<h3 id="typeguards-as-methods">TypeGuards as methods<a class="headerlink" href="#typeguards-as-methods" title="Permanent link">&para;</a></h3>
<blockquote>
<p>A method can also serve as the <code>TypeGuard</code>:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">StrValidator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">to_validate</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">StrValidator</span><span class="p">()</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">to_validate</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">to_validate</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;builtins.str&quot;</span>
</code></pre></div>
<p>:::{note}
Note, that <code>TypeGuard</code>
<a href="https://www.python.org/dev/peps/pep-0647/#narrowing-of-implicit-self-and-cls-parameters">does not narrow</a>
types of <code>self</code> or <code>cls</code> implicit arguments.</p>
<p>If narrowing of <code>self</code> or <code>cls</code> is required,
the value can be passed as an explicit argument to a type guard function:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Parent</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Parent&quot;</span>
        <span class="k">if</span> <span class="n">is_child</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">reveal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Revealed type is &quot;Child&quot;</span>

<span class="k">class</span> <span class="nc">Child</span><span class="p">(</span><span class="n">Parent</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">is_child</span><span class="p">(</span><span class="n">instance</span><span class="p">:</span> <span class="n">Parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="n">Child</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Child</span><span class="p">)</span>
</code></pre></div>
<p>:::</p>
<h3 id="assignment-expressions-as-typeguards">Assignment expressions as TypeGuards<a class="headerlink" href="#assignment-expressions-as-typeguards" title="Permanent link">&para;</a></h3>
<p>Sometimes you might need to create a new variable and narrow it
to some specific type at the same time.
This can be achieved by using <code>TypeGuard</code> together
with <a href="https://docs.python.org/3/whatsnew/3.8.html#assignment-expressions">:= operator</a>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeGuard</span>  <span class="c1"># use `typing_extensions` for `python&lt;3.10`</span>

<span class="k">def</span> <span class="nf">is_float</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TypeGuard</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_float</span><span class="p">(</span><span class="n">x</span> <span class="o">:=</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.float&#39;</span>
        <span class="n">reveal_type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
    <span class="n">reveal_type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># N: Revealed type is &#39;builtins.object&#39;</span>
</code></pre></div>
<p>What happens here?</p>
<ol>
<li>We create a new variable <code>x</code> and assign a value of <code>a</code> to it</li>
<li>We run <code>is_float()</code> type guard on <code>x</code></li>
<li>It narrows <code>x</code> to be <code>float</code> in the <code>if</code> context and does not touch <code>a</code></li>
</ol>
<p>:::{note}
The same will work with <code>isinstance(x := a, float)</code> as well.
:::</p>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年7月6日</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年7月6日</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "toc.follow"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c2be25ad.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>