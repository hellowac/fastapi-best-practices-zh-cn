
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastApi 最佳实践-中文版">
      
      
      
      
      
        <link rel="next" href="raw_en/">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>FastApi 最佳实践-中文版</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.26e3688c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fastapi-最佳实践" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="FastApi 最佳实践-中文版" class="md-header__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastApi 最佳实践-中文版
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              最佳实践
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="." class="md-tabs__link md-tabs__link--active">
      最佳实践
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="raw_en/" class="md-tabs__link">
      英文原版
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="asyncio/asyncio/" class="md-tabs__link">
        Asyncio
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="network/internet_protocol_suite_part_i/" class="md-tabs__link">
        互联网协议
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="http/" class="md-tabs__link">
        HTTP
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="rest-ful/restapi/" class="md-tabs__link">
        REST ful
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="git/git-branch-manage/" class="md-tabs__link">
        Git
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="system-design/perm_design/" class="md-tabs__link">
        系统设计
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="about/" class="md-tabs__link">
      关于
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="FastApi 最佳实践-中文版" class="md-nav__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FastApi 最佳实践-中文版
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          最佳实践
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        最佳实践
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-项目结构-一致且可预测" class="md-nav__link">
    1. 项目结构。 一致且可预测
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-尽可能的使用-pydantic-进行数据验证" class="md-nav__link">
    2. 尽可能的使用 Pydantic 进行数据验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-使用depends依赖进行与数据库有关的数据验证" class="md-nav__link">
    3. 使用Depends(依赖)进行与数据库有关的数据验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-依赖dependency链" class="md-nav__link">
    4. 依赖(Dependency)链
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-解耦和重用依赖关系-缓存依赖dependency调用结果" class="md-nav__link">
    5. 解耦和重用依赖关系。 缓存依赖(Dependency)调用结果
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-遵循-rest-规范" class="md-nav__link">
    6. 遵循 REST 规范
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-如果你的路由只有阻塞的-io-操作-不要让你的路由异步" class="md-nav__link">
    7. 如果你的路由只有阻塞的 I/O 操作, 不要让你的路由异步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-从第-0-天开始的自定义基础模型" class="md-nav__link">
    8. 从第 0 天开始的自定义基础模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-文档docs" class="md-nav__link">
    9. 文档(Docs)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-使用-pydantic-的-basesettings-进行配置" class="md-nav__link">
    10. 使用 Pydantic 的 BaseSettings 进行配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-sqlalchemy-设置数据库键命名约定" class="md-nav__link">
    11. SQLAlchemy: 设置数据库键命名约定
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-迁移-alembic" class="md-nav__link">
    12. 迁移: Alembic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-设置数据库表字典命名约定" class="md-nav__link">
    13. 设置数据库(表/字典)命名约定
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-从第0天开始写基于异步的测试" class="md-nav__link">
    14. 从第0天开始写基于异步的测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-后台任务使用-asynciocreate_task" class="md-nav__link">
    15. 后台任务使用 asyncio.create_task
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-类型注解很重要" class="md-nav__link">
    16. 类型注解很重要
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-以chunks块的形式保存文件" class="md-nav__link">
    17. 以chunks(块)的形式保存文件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-小心pydantic的动态字段" class="md-nav__link">
    18. 小心pydantic的动态字段
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-sql-第一-pydantic-第二" class="md-nav__link">
    19. SQL-第一, Pydantic-第二
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-验证host如果用户可以发送公开可用的-url" class="md-nav__link">
    20. 验证host，如果用户可以发送公开可用的 URL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-如果schema直接面向客户端在pydantic的自定义校验中抛出valueerror" class="md-nav__link">
    21. 如果schema直接面向客户端，在pydantic的自定义校验中抛出ValueError
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-不要忘记-fastapi-将-response-的-pydantic-对象转换为-dict然后转换为-responsemodel-的实例然后转换为-dict然后转换为-json" class="md-nav__link">
    22. 不要忘记 FastAPI 将 Response 的 Pydantic 对象转换为 Dict，然后转换为 ResponseModel 的实例，然后转换为 Dict，然后转换为 JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-如果你必须使用sync同步-sdk-请在线程池中运行" class="md-nav__link">
    23. 如果你必须使用sync(同步) SDK, 请在线程池中运行
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-使用-linters-black-isort-autoflake" class="md-nav__link">
    24. 使用 linters (black, isort, autoflake)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#惊喜部分" class="md-nav__link">
    惊喜部分
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="raw_en/" class="md-nav__link">
        英文原版
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Asyncio
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Asyncio
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/asyncio/" class="md-nav__link">
        中文简单指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/asyncio_en/" class="md-nav__link">
        中英对照指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/cheat_sheet/" class="md-nav__link">
        语法备忘录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/api_mind_map/" class="md-nav__link">
        API思维导图
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          互联网协议
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          互联网协议
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="network/internet_protocol_suite_part_i/" class="md-nav__link">
        互联网协议入门（一）
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="network/internet_protocol_suite_part_ii/" class="md-nav__link">
        互联网协议入门（二）
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="http/">HTTP</a>
          
            <label for="__nav_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          HTTP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="http/http-referer/" class="md-nav__link">
        HTTP Referer 教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="http/https/" class="md-nav__link">
        HTTPS 升级指南
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          REST ful
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          REST ful
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="rest-ful/restapi/" class="md-nav__link">
        Restful API 设计指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="rest-ful/restapibsetp/" class="md-nav__link">
        RESTful API 最佳实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          Git
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Git
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="git/git-branch-manage/" class="md-nav__link">
        Git分支管理策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="git/git-remote/" class="md-nav__link">
        Git远程操作详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="git/git-use-process/" class="md-nav__link">
        Git 使用规范流程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="git/git-cheat-sheet/" class="md-nav__link">
        常用 Git 命令清单
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="git/git-work-flow/" class="md-nav__link">
        Git 协作流程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          系统设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          系统设计
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="system-design/perm_design/" class="md-nav__link">
        权限系统的设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="about/" class="md-nav__link">
        关于
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-项目结构-一致且可预测" class="md-nav__link">
    1. 项目结构。 一致且可预测
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-尽可能的使用-pydantic-进行数据验证" class="md-nav__link">
    2. 尽可能的使用 Pydantic 进行数据验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-使用depends依赖进行与数据库有关的数据验证" class="md-nav__link">
    3. 使用Depends(依赖)进行与数据库有关的数据验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-依赖dependency链" class="md-nav__link">
    4. 依赖(Dependency)链
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-解耦和重用依赖关系-缓存依赖dependency调用结果" class="md-nav__link">
    5. 解耦和重用依赖关系。 缓存依赖(Dependency)调用结果
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-遵循-rest-规范" class="md-nav__link">
    6. 遵循 REST 规范
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-如果你的路由只有阻塞的-io-操作-不要让你的路由异步" class="md-nav__link">
    7. 如果你的路由只有阻塞的 I/O 操作, 不要让你的路由异步
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-从第-0-天开始的自定义基础模型" class="md-nav__link">
    8. 从第 0 天开始的自定义基础模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-文档docs" class="md-nav__link">
    9. 文档(Docs)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-使用-pydantic-的-basesettings-进行配置" class="md-nav__link">
    10. 使用 Pydantic 的 BaseSettings 进行配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-sqlalchemy-设置数据库键命名约定" class="md-nav__link">
    11. SQLAlchemy: 设置数据库键命名约定
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-迁移-alembic" class="md-nav__link">
    12. 迁移: Alembic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-设置数据库表字典命名约定" class="md-nav__link">
    13. 设置数据库(表/字典)命名约定
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-从第0天开始写基于异步的测试" class="md-nav__link">
    14. 从第0天开始写基于异步的测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-后台任务使用-asynciocreate_task" class="md-nav__link">
    15. 后台任务使用 asyncio.create_task
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-类型注解很重要" class="md-nav__link">
    16. 类型注解很重要
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-以chunks块的形式保存文件" class="md-nav__link">
    17. 以chunks(块)的形式保存文件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-小心pydantic的动态字段" class="md-nav__link">
    18. 小心pydantic的动态字段
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-sql-第一-pydantic-第二" class="md-nav__link">
    19. SQL-第一, Pydantic-第二
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-验证host如果用户可以发送公开可用的-url" class="md-nav__link">
    20. 验证host，如果用户可以发送公开可用的 URL
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-如果schema直接面向客户端在pydantic的自定义校验中抛出valueerror" class="md-nav__link">
    21. 如果schema直接面向客户端，在pydantic的自定义校验中抛出ValueError
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-不要忘记-fastapi-将-response-的-pydantic-对象转换为-dict然后转换为-responsemodel-的实例然后转换为-dict然后转换为-json" class="md-nav__link">
    22. 不要忘记 FastAPI 将 Response 的 Pydantic 对象转换为 Dict，然后转换为 ResponseModel 的实例，然后转换为 Dict，然后转换为 JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-如果你必须使用sync同步-sdk-请在线程池中运行" class="md-nav__link">
    23. 如果你必须使用sync(同步) SDK, 请在线程池中运行
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-使用-linters-black-isort-autoflake" class="md-nav__link">
    24. 使用 linters (black, isort, autoflake)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#惊喜部分" class="md-nav__link">
    惊喜部分
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="fastapi-最佳实践">FastAPI 最佳实践<a class="headerlink" href="#fastapi-最佳实践" title="Permanent link">&para;</a></h1>
<p>我们在创业时使用的并且自以为是的最佳实践和惯例列表。</p>
<p>在过去 1.5 年的生产中，
我们一直在做出好的和坏的决定，这些决定极大地影响了我们的开发人员体验。
其中一些值得分享。</p>
<h2 id="1-项目结构-一致且可预测">1. 项目结构。 一致且可预测<a class="headerlink" href="#1-项目结构-一致且可预测" title="Permanent link">&para;</a></h2>
<p>构建项目的方法有很多种，但最好的结构是一致、直接且没有意外的结构。</p>
<ul>
<li>如果查看项目结构不能让您了解项目的内容，那么结构可能不清楚。</li>
<li>如果您必须打开包才能了解其中包含哪些模块，那么您的结构就不清楚了。</li>
<li>如果文件的重复率和位置感觉是随机的，那么您的项目结构很糟糕。</li>
<li>如果查看模块的位置及其名称不能让您了解其中的内容，那么您的结构非常糟糕。</li>
</ul>
<p><a href="https://github.com/tiangolo">@tiangolo</a> 提供的项目结构（我们按文件类型（例如 api、crud、模型、模式）分隔文件）适用于微服务或范围较小的项目，但我们无法将它放入我们具有大量域和模块的整体中。</p>
<p>我发现更具可扩展性和可演化性的结构是受 Netflix 的 <a href="https://github.com/Netflix/dispatch">Dispatch</a> 启发并稍作修改。</p>
<div class="highlight"><pre><span></span><code>fastapi-project
├── alembic/
├── src
│   ├── auth
│   │   ├── router.py
│   │   ├── schemas.py  # pydantic 模型
│   │   ├── models.py  # db 模型
│   │   ├── dependencies.py
│   │   ├── config.py  # 本地配置
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── aws
│   │   ├── client.py  # 外部服务通信的客户端模型
│   │   ├── schemas.py
│   │   ├── config.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   └── utils.py
│   └── posts
│   │   ├── router.py
│   │   ├── schemas.py
│   │   ├── models.py
│   │   ├── dependencies.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── config.py  # 全局配置
│   ├── models.py  # 全局模型
│   ├── exceptions.py  # 全局异常
│   ├── pagination.py  # 全局模块 例如. pagination 分页
│   ├── database.py  # 数据库连接相关的东西
│   └── main.py
├── tests/
│   ├── auth
│   ├── aws
│   └── posts
├── templates/
│   └── index.html
├── requirements
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
├── .env
├── .gitignore
├── logging.ini
└── alembic.ini
</code></pre></div>
<ol>
<li>将所有域目录存储在 <code>src</code> 文件夹中<ol>
<li><code>src/</code> - 应用程序的最高级别，包含通用模型、配置和常量等。</li>
<li><code>src/main.py</code> - 项目的根目录，用于启动 FastAPI 应用程序</li>
</ol>
</li>
<li>每个包都有自己的 router, schemas, models, 等。<ol>
<li><code>router.py</code> - 每个模块的核心，是所有路由接口的入口。</li>
<li><code>schemas.py</code> - 每个模块的 pydantic的模型</li>
<li><code>models.py</code> - 每个模块的数据库模型</li>
<li><code>service.py</code> - 模块特有的业务逻辑</li>
<li><code>dependencies.py</code> - 路由依赖(Depends)</li>
<li><code>constants.py</code> - 模块特有的常量和错误码定义</li>
<li><code>config.py</code> - 例如，环境变量</li>
<li><code>utils.py</code> - 非业务逻辑功能， 例如. 响应规范化、数据丰富等。</li>
<li><code>exceptions</code> - 模块特有的一场，例如. <code>PostNotFound</code>, <code>InvalidUserData</code></li>
</ol>
</li>
<li>当包需要来自其他包的服务或依赖项或常量时 - 使用显式模块名称导入它们</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">src.auth</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">auth_constants</span>
<span class="kn">from</span> <span class="nn">src.notifications</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">notification_service</span>
<span class="kn">from</span> <span class="nn">src.posts.constants</span> <span class="kn">import</span> <span class="n">ErrorCode</span> <span class="k">as</span> <span class="n">PostsErrorCode</span>  <span class="c1"># 如果我们在每个包的常量模块中都有标准错误代码</span>
</code></pre></div>
<h2 id="2-尽可能的使用-pydantic-进行数据验证">2. 尽可能的使用 Pydantic 进行数据验证<a class="headerlink" href="#2-尽可能的使用-pydantic-进行数据验证" title="Permanent link">&para;</a></h2>
<p>Pydantic 具有一组丰富的功能来验证和转换数据。</p>
<p>除了具有默认值的必填和非必填字段等常规功能外，</p>
<p>Pydantic 内置了全面的数据处理工具，如正则表达式、有限允许选项的枚举、长度验证、电子邮件验证等。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">AnyUrl</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">constr</span>

<span class="k">class</span> <span class="nc">MusicBand</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
   <span class="n">AEROSMITH</span> <span class="o">=</span> <span class="s2">&quot;AEROSMITH&quot;</span>
   <span class="n">QUEEN</span> <span class="o">=</span> <span class="s2">&quot;QUEEN&quot;</span>
   <span class="n">ACDC</span> <span class="o">=</span> <span class="s2">&quot;AC/DC&quot;</span>


<span class="k">class</span> <span class="nc">UserBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">constr</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;^[A-Za-z0-9-_]+$&quot;</span><span class="p">,</span> <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">strip_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># must be greater or equal to 18</span>
    <span class="n">favorite_band</span><span class="p">:</span> <span class="n">MusicBand</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># only &quot;AEROSMITH&quot;, &quot;QUEEN&quot;, &quot;AC/DC&quot; values are allowed to be inputted</span>
    <span class="n">website</span><span class="p">:</span> <span class="n">AnyUrl</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<h2 id="3-使用depends依赖进行与数据库有关的数据验证">3. 使用Depends(依赖)进行与数据库有关的数据验证<a class="headerlink" href="#3-使用depends依赖进行与数据库有关的数据验证" title="Permanent link">&para;</a></h2>
<p>Pydantic 可以只验证来自客户端输入的值。</p>
<p>使用依赖项根据数据库约束验证数据，例如电子邮件已存在、未找到用户等。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_by_id</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">update_post</span><span class="p">(</span>
    <span class="n">update_data</span><span class="p">:</span> <span class="n">PostUpdate</span><span class="p">,</span>  
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
<span class="p">):</span>
    <span class="n">updated_post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">update_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">/reviews&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">ReviewsResponse</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_post_reviews</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="n">post_reviews</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reviews_service</span><span class="o">.</span><span class="n">get_by_post_id</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post_reviews</span>
</code></pre></div>
<p>如果我们不将数据验证放在依赖项中，我们将不得不为每个接口添加 <code>post_id</code> 验证并为每个接口编写相同的测试。</p>
<h2 id="4-依赖dependency链">4. 依赖(Dependency)链<a class="headerlink" href="#4-依赖dependency链" title="Permanent link">&para;</a></h2>
<p>依赖可以使用其他依赖，避免类似逻辑的代码重复。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span> <span class="nn">fastapi.security</span> <span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span> <span class="nn">jose</span> <span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>

<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
<h2 id="5-解耦和重用依赖关系-缓存依赖dependency调用结果">5. 解耦和重用依赖关系。 缓存依赖(Dependency)调用结果<a class="headerlink" href="#5-解耦和重用依赖关系-缓存依赖dependency调用结果" title="Permanent link">&para;</a></h2>
<p>依赖项可以多次重用，并且不会重新计算 - 默认情况下，FastAPI 将依赖项的结果缓存在请求的范围内。</p>
<p>例如：如果我们有一个调用服务 <code>get_post_by_id</code> 的依赖项，我们将不会在每次调用该依赖项时都访问数据库 - 只有第一次函数调用时会用到。</p>
<p>知道了这一点，我们可以轻松地将依赖关系解耦到多个较小的函数上，这些函数在较小的域上运行并且更容易在其他路由中重用。</p>
<p>例如，在下面的代码中，我们使用了 3 次 <code>parse_jwt_data</code>：</p>
<ol>
<li><code>valid_owned_post</code></li>
<li><code>valid_active_creator</code></li>
<li><code>get_user_post</code></li>
</ol>
<p>但是 <code>parse_jwt_data</code> 在第一次调用时只被调用一次。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">BackgroundTasks</span>
<span class="kn">from</span> <span class="nn">fastapi.security</span> <span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span> <span class="nn">jose</span> <span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_active_creator</span><span class="p">(</span>
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">users_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserIsBanned</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
       <span class="k">raise</span> <span class="n">UserNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user_post</span><span class="p">(</span>
    <span class="n">worker</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">),</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_active_creator</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get post that belong the active user.&quot;&quot;&quot;</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">notifications_service</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
<h2 id="6-遵循-rest-规范">6. 遵循 REST 规范<a class="headerlink" href="#6-遵循-rest-规范" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">译者注 - REST API 设计规范</p>
<p>参考 <a href="http://www.ruanyifeng.com/" target="_blank">阮一峰</a>老师的 - <a href="rest-ful/restapi/" target="_blank">RESTful API 设计指南</a> 和 <a href="rest-ful/restapibsetp/" target="_blank">RESTful API 最佳实践</a></p>
</div>
<p>开发 RESTful API 可以更轻松地在如下路由中重用依赖项：</p>
<ol>
<li><code>GET /courses/:course_id</code></li>
<li><code>GET /courses/:course_id/chapters/:chapter_id/lessons</code></li>
<li><code>GET /chapters/:chapter_id</code></li>
</ol>
<p>唯一需要注意的是在路径中使用相同的变量名：</p>
<ul>
<li>如果你有两个接口 <code>GET /profiles/:profile_id</code> 和 <code>GET /creators/:creator_id</code> 两者都验证给定的 <code>profile_id</code> 是否存在，但是 <code>GET /creators/:creator_id</code> 还检查配置文件是否是创建者，那么最好将 <code>creator_id</code> 路径变量重命名为 <code>profile_id</code> 并将这两个依赖项链接起来。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.dependencies</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_profile_id</span><span class="p">(</span><span class="n">profile_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ProfileNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.dependencies</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">valid_creator_id</span><span class="p">(</span>
    <span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
       <span class="k">raise</span> <span class="n">ProfileNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.profiles.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/profiles/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user_profile_by_id</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get profile by id.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_user_profile_by_id</span><span class="p">(</span>
     <span class="n">creator_profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get creator&#39;s profile by id.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">creator_profile</span>
</code></pre></div>
<p>使用 <code>/me</code> 路由定义来返回当前用户资源 (例如. <code>GET /profiles/me</code>, <code>GET /users/me/posts</code>)</p>
<ol>
<li>无需检查用户ID是否存在 - 因为auth校验早已校验了其是否存在。</li>
<li>无需检查用户ID是否属于请求者</li>
</ol>
<h2 id="7-如果你的路由只有阻塞的-io-操作-不要让你的路由异步">7. 如果你的路由只有阻塞的 I/O 操作, 不要让你的路由异步<a class="headerlink" href="#7-如果你的路由只有阻塞的-io-操作-不要让你的路由异步" title="Permanent link">&para;</a></h2>
<p>在底层，FastAPI 可以<a href="https://fastapi.tiangolo.com/async/#path-operation-functions">有效地处理</a> 异步和同步 I/O 操作。</p>
<ul>
<li>FastAPI 在<a href="https://en.wikipedia.org/wiki/Thread_pool">线程池</a> 中运行<code>sync</code>(同步)路由，阻塞 I/O 操作不会阻止[事件循环](<a href="https://docs.python.org/3/library/asyncio-eventloop.html">https://docs.python.org/3/library/asyncio-eventloop.html</a>）执行任务。</li>
<li>否则，如果路由被定义为<code>async</code>，那么它会通过<code>await</code>定期调用，并且 FastAPI 相信您只会执行非阻塞 I/O 操作。</li>
</ul>
<p>需要注意的是，如果您未能信任并在异步路由中执行阻塞操作，事件循环将无法运行下一个任务，直到该阻塞操作完成。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/terrible-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">terrible_catastrophic_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># I/O阻塞操作10秒</span>
    <span class="n">pong</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_pong</span><span class="p">()</span>  <span class="c1"># 从 DB 获取 pong 的 I/O 阻塞操作</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="n">pong</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/good-ping&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">good_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># I/O 阻塞操作 10 秒，但在另一个线程中</span>
    <span class="n">pong</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">get_pong</span><span class="p">()</span>  <span class="c1"># 从数据库中获取 pong 的 I/O 阻塞操作，但在另一个线程中</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="n">pong</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/perfect-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">perfect_ping</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 异步阻塞 I/O 操作</span>
    <span class="n">pong</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">async_get_pong</span><span class="p">()</span>  <span class="c1"># 异步阻塞 I/O 数据库调用</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="n">pong</span><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title"><strong>当我们调用时会发生什么</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1"><code>GET /terrible-ping</code></label><label for="__tabbed_1_2"><code>GET /good-ping</code></label><label for="__tabbed_1_3"><code>GET /perfect-ping</code></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>FastAPI 服务器收到一个请求并开始处理它</li>
<li>服务器的事件循环和队列中的所有任务将等待直到 <code>time.sleep()</code> 完成<ol>
<li>服务器认为 <code>time.sleep()</code> 不是一个 I/O 任务, 所以会一直等待并直到它完成。</li>
<li>在等待期间服务器不会接受任何新的请求。</li>
</ol>
</li>
<li>然后, 事件循环和所有任务会在队列中一起等待，直到<code>service.get_pong</code>执行完毕。<ol>
<li>服务器认为 <code>service.get_pong()</code> 不是一个 I/O 任务, 所以他会一直等待，直到它完成。</li>
<li>服务器在等待期间不会接受任何新的的请求。</li>
</ol>
</li>
<li>服务器返回响应。<ol>
<li>响应之后, 服务器开始接受新的请求。</li>
</ol>
</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>FastAPI 服务器收到一个请求并开始处理它</li>
<li>FastAPI 将整个路由 <code>good_ping</code> 分配到线程池中, 池中有工作线程负责运行该路由绑定的函数。</li>
<li>在 <code>good_ping</code> 执行其间, 事件循环会从队列中选择下一个任务和工作线程给他们， (比如. 接受新请求, 调用数据库)<ul>
<li>工作线程独立于主线程 (比如. 我们的 FastAPI 应用程序), 它将等待 <code>time.sleep</code> 完成，然后等待 <code>service.get_pong</code> 完成。</li>
<li>Sync(同步)操作只会阻塞子线程，不会阻塞主线程。</li>
</ul>
</li>
<li>然后 <code>good_ping</code> 完成他的工作, 服务器返回一个响应给客户端。</li>
</ol>
</div>
<div class="tabbed-block">
<ol>
<li>FastAPI 服务器收到一个请求并开始处理它</li>
<li>FastAPI 异步等待 <code>asyncio.sleep(10)</code></li>
<li>事件循环从队列中选择下一个任务并处理它们  (比如. 接受新请求, 调用数据库)</li>
<li>当 <code>asyncio.sleep(10)</code> 完成时, 服务器转到下一行并等待 <code>service.async_get_pong</code> 完成。</li>
<li>事件循环从队列中选择下一个任务并处理它们  (比如. 接受新请求, 调用数据库)</li>
<li>当 <code>service.async_get_pong</code> 完成, 服务器返回一个响应给客户端。</li>
</ol>
</div>
</div>
</div>
</div>
<p>第二个需要强调的是，non-blocking awaitables (非阻塞等待)或者发送到线程池的操作必须是I/O密集型任务(比如: 打开文件、数据库调用、外部API调用等等)。</p>
<ul>
<li>等待CPU密集型任务 (比如. 负责的计算, 数据处理, 视频转码) 是没有价值的，因为CPU必须工作才能完成计算任务, 而I/O操作是外部的，服务器在等待该操作完成时什么都不做，因此它可以去做下一个任务。</li>
<li>由于 <a href="https://realpython.com/python-gil/">GIL</a>，在其他线程中运行 CPU 密集型任务也不是有效的。 简而言之，GIL 一次只允许一个线程工作，这使得它对 CPU密集型任务毫无用处。</li>
<li>如果你想优化 CPU 密集型任务，你应该将它们发送给另一个进程中进行工作。</li>
</ul>
<p><strong>StackOverflow上困惑用户的相关问题</strong>:</p>
<ol>
<li><a href="https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597">https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597</a> - 同样可以看看 <a href="https://stackoverflow.com/a/70309597/6927498">我的回答</a></li>
<li><a href="https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask">https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask</a></li>
<li><a href="https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion">https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion</a></li>
</ol>
<h2 id="8-从第-0-天开始的自定义基础模型">8. 从第 0 天开始的自定义基础模型<a class="headerlink" href="#8-从第-0-天开始的自定义基础模型" title="Permanent link">&para;</a></h2>
<p>拥有可控的全局基础模型使我们能够自定义应用程序中的所有模型。</p>
<p>例如，我们可以有一个标准的日期时间格式或为基础模型的所有子类添加一个超级方法。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">zoneinfo</span> <span class="kn">import</span> <span class="n">ZoneInfo</span>

<span class="kn">import</span> <span class="nn">orjson</span>
<span class="kn">from</span> <span class="nn">fastapi.encoders</span> <span class="kn">import</span> <span class="n">jsonable_encoder</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">root_validator</span>


<span class="k">def</span> <span class="nf">orjson_dumps</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="c1"># orjson.dumps 返回字节，为了匹配标准的 json.dumps, 我们需要解码。</span>
    <span class="k">return</span> <span class="n">orjson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">convert_datetime_to_gmt</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ORJSONModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">json_loads</span> <span class="o">=</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span>
        <span class="n">json_dumps</span> <span class="o">=</span> <span class="n">orjson_dumps</span>
        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span><span class="n">datetime</span><span class="p">:</span> <span class="n">convert_datetime_to_gmt</span><span class="p">}</span>  <span class="c1"># 日期时间字段的自定义 JSON 编码方法</span>

    <span class="nd">@root_validator</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">set_null_microseconds</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;在所有日期时间字段值中删除微秒。&quot;&quot;&quot;</span>
        <span class="n">datetime_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">datetime_fields</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">serializable_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;返回一个只包含可序列化字段的字典。&quot;&quot;&quot;</span>
        <span class="n">default_dict</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jsonable_encoder</span><span class="p">(</span><span class="n">default_dict</span><span class="p">)</span>
</code></pre></div>
<p>在上面的示例中，我们决定制作一个全局基础模型：</p>
<ul>
<li>使用 <a href="https://github.com/ijl/orjson">orjson</a> 用于数据的序列化</li>
<li>在所有日期格式中将微秒降为 0</li>
<li>将所有日期时间字段序列化为具有显式时区的标准格式</li>
</ul>
<h2 id="9-文档docs">9. 文档(Docs)<a class="headerlink" href="#9-文档docs" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>除非您的 API 是公开的，否则默认情况下隐藏文档。 仅在选定的环境中明确显示它。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">starlette.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">)</span>  <span class="c1"># 解析 .env 文件中的环境变量</span>

<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">)</span>  <span class="c1"># 获取当前环境名称</span>
<span class="n">SHOW_DOCS_ENVIRONMENT</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span><span class="p">)</span>  <span class="c1"># 允许显示文档的环境名称列表</span>

<span class="n">app_configs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My Cool API&quot;</span><span class="p">}</span>
<span class="k">if</span> <span class="n">ENVIRONMENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SHOW_DOCS_ENVIRONMENT</span><span class="p">:</span>
   <span class="n">app_configs</span><span class="p">[</span><span class="s2">&quot;openapi_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 将文档的 url 设置为 null</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="o">**</span><span class="n">app_configs</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>帮助FastAPI生成通俗易懂的文档</p>
</li>
<li>设置 <code>response_model</code>, <code>status_code</code>, <code>description</code>, 等字段.</li>
<li>如果响应模型和状态不同，使用 <code>responses</code> 路由属性为不同的响应添加文档</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">status</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/endpoints&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">DefaultResponseModel</span><span class="p">,</span>  <span class="c1"># 默认响应的 pydantic 模型</span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>  <span class="c1"># 默认状态码</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;文档接口的清晰描述&quot;</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Endpoint Category&quot;</span><span class="p">],</span>  <span class="c1"># 接口分类</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Summary of the Endpoint&quot;</span><span class="p">,</span>  <span class="c1"># 接口概要</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">OkResponse</span><span class="p">,</span> <span class="c1"># 自定义 pydantic 模型，用于 200 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Ok Response&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">CreatedResponse</span><span class="p">,</span>  <span class="c1"># 自定义 pydantic 模型，用于 201 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Creates something from user request &quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_202_ACCEPTED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">AcceptedResponse</span><span class="p">,</span>  <span class="c1"># 自定义 pydantic 模型，用于 202 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Accepts request and handles it later&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">documented_route</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>
<p>即生成的文档就像这样: <a class="glightbox" href="images/custom_responses.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="FastAPI Generated Custom Response Docs" src="images/custom_responses.png" title="自定义响应文档" /></a></p>
<h2 id="10-使用-pydantic-的-basesettings-进行配置">10. 使用 Pydantic 的 BaseSettings 进行配置<a class="headerlink" href="#10-使用-pydantic-的-basesettings-进行配置" title="Permanent link">&para;</a></h2>
<p>Pydantic 提供了一个<a href="https://pydantic-docs.helpmanual.io/usage/settings/">强大的工具</a> 来解析环境变量并使用其验证器处理它们。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">AnyUrl</span><span class="p">,</span> <span class="n">BaseSettings</span><span class="p">,</span> <span class="n">PostgresDsn</span>

<span class="k">class</span> <span class="nc">AppSettings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">env_file</span> <span class="o">=</span> <span class="s2">&quot;.env&quot;</span>
        <span class="n">env_file_encoding</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="n">env_prefix</span> <span class="o">=</span> <span class="s2">&quot;app_&quot;</span>

    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="n">PostgresDsn</span>
    <span class="n">IS_GOOD_ENV</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ALLOWED_CORS_ORIGINS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">AnyUrl</span><span class="p">]</span>
</code></pre></div>
<h2 id="11-sqlalchemy-设置数据库键命名约定">11. SQLAlchemy: 设置数据库键命名约定<a class="headerlink" href="#11-sqlalchemy-设置数据库键命名约定" title="Permanent link">&para;</a></h2>
<p>根据您的数据库约定明确设置索引的命名优于 <code>sqlalchemy</code> 自动命名。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(column_0_label)s</span><span class="s2">_idx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_key&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">_check&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_fkey&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_pkey&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span><span class="p">)</span>
</code></pre></div>
<h2 id="12-迁移-alembic">12. 迁移: Alembic<a class="headerlink" href="#12-迁移-alembic" title="Permanent link">&para;</a></h2>
<ol>
<li>迁移必须是静态的和可恢复的。 如果您的迁移依赖于动态生成的数据，那么请确保唯一动态的是数据本身，而不是其结构。</li>
<li>生成具有描述性名称和 slug 的迁移。 Slug 是必需的，应该解释这些变化。</li>
<li>为新迁移设置人类可读的文件模板。 我们使用 <code>*date*_*slug*.py</code> 模式，例如 <code>2022-08-24_post_content_idx.py</code></li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># alembic.ini</span>
<span class="na">file_template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">%%(year)d-%%(month).2d-%%(day).2d_%%(slug)s</span>
</code></pre></div>
<h2 id="13-设置数据库表字典命名约定">13. 设置数据库(表/字典)命名约定<a class="headerlink" href="#13-设置数据库表字典命名约定" title="Permanent link">&para;</a></h2>
<p>命名保持一致很重要。 我们遵循的一些规则：</p>
<ol>
<li>lower_case_snake (小写驼峰命名)</li>
<li>单数形式 (例如. <code>post</code>, <code>post_like</code>, <code>user_playlist</code>)</li>
<li>使用模块前缀对相似表进行分组, 例如. <code>payment_account</code>, <code>payment_bill</code>, <code>post</code>, <code>post_like</code></li>
<li>跨表命名保持一致，但具体的命名是可以的, 例如.</li>
<li>在所有表中使用 <code>profile_id</code>，但如果其中一些只需要作为创建者的配置文件，请使用 <code>creator_id</code></li>
<li>在所有抽象表，形如 <code>post_like</code> 、 <code>post_view</code> 中使用 <code>post_id</code> ，但在相关模块中使用具体命名，如 <code>chapters.course_id</code> 中的 <code>course_id</code> 。</li>
<li><code>_at</code> 作为 <code>datetime</code> 类型的后缀</li>
<li><code>_date</code> 作为 <code>date</code> 类型的后缀</li>
</ol>
<h2 id="14-从第0天开始写基于异步的测试">14. 从第0天开始写基于异步的测试<a class="headerlink" href="#14-从第0天开始写基于异步的测试" title="Permanent link">&para;</a></h2>
<p>基于DB写集成测试很有可能导致在将来出现基于事件循环的错误。</p>
<p>立即开始基于异步测试客户端的测试， 例如. <a href="https://github.com/vinissimus/async-asgi-testclient">async_asgi_testclient</a> 或 <a href="https://github.com/encode/starlette/issues/652">httpx</a></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">async_asgi_testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span> <span class="nn">src.main</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># inited FastAPI app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;5555&quot;</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;client&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)}</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">TestClient</span><span class="p">(</span>
        <span class="n">app</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-User-Fingerprint&quot;</span><span class="p">:</span> <span class="s2">&quot;Test&quot;</span><span class="p">}</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_create_post</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
</code></pre></div>
<p>除非你有同步到数据库连接（打扰了？）或者不打算编写集成测试。</p>
<h2 id="15-后台任务使用-asynciocreate_task">15. 后台任务使用 asyncio.create_task<a class="headerlink" href="#15-后台任务使用-asynciocreate_task" title="Permanent link">&para;</a></h2>
<p>BackgroundTasks 可以 <a href="https://github.com/encode/starlette/blob/31164e346b9bd1ce17d968e1301c3bb2c23bb418/starlette/background.py#L25">有效运行</a>
所有的阻塞和非阻塞I/O操作, 就像FastAPI 处理阻塞路由一样。 (<code>sync</code>(同步)任务在线程池中运行, 而 <code>async</code>(异步) 人物则等待中稍后运行。)</p>
<ul>
<li>不要欺骗工作例程以及将阻塞的I/O操作标记为<code>async</code>(异步).（这样做的话，会阻塞事件调用循环，导致影响其他的异步任务调用）</li>
<li>不要将它用于繁重的CPU密集型任务。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">BackgroundTasks</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">UUID4</span>

<span class="kn">from</span> <span class="nn">src.notifications</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">notifications_service</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/email&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">send_user_email</span><span class="p">(</span><span class="n">worker</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send email to user&quot;&quot;&quot;</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">notifications_service</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>  <span class="c1"># send email after responding client</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</code></pre></div>
<h2 id="16-类型注解很重要">16. 类型注解很重要<a class="headerlink" href="#16-类型注解很重要" title="Permanent link">&para;</a></h2>
<p>FastAPI, Pydantic, 以及现代的 IDE 鼓励使用类型提示。</p>
<p><strong>没有类型提示</strong>:</p>
<p><a class="glightbox" href="images/type_hintsless.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="type_hintsless" src="images/type_hintsless.png" /></a></p>
<p><strong>有类型提示</strong>:</p>
<p><a class="glightbox" href="images/type_hints.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="type_hints" src="images/type_hints.png" /></a></p>
<h2 id="17-以chunks块的形式保存文件">17. 以chunks(块)的形式保存文件<a class="headerlink" href="#17-以chunks块的形式保存文件" title="Permanent link">&para;</a></h2>
<p>不要期望您的客户端发送小文件。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">aiofiles</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">UploadFile</span>

<span class="n">DEFAULT_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">50</span>  <span class="c1"># 50 megabytes MB(兆字节)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">save_video</span><span class="p">(</span><span class="n">video_file</span><span class="p">:</span> <span class="n">UploadFile</span><span class="p">):</span>
   <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;/file/path/name.mp4&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
     <span class="k">while</span> <span class="n">chunk</span> <span class="o">:=</span> <span class="k">await</span> <span class="n">video_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">DEFAULT_CHUNK_SIZE</span><span class="p">):</span>
         <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div>
<h2 id="18-小心pydantic的动态字段">18. 小心pydantic的动态字段<a class="headerlink" href="#18-小心pydantic的动态字段" title="Permanent link">&para;</a></h2>
<p>如果你有一个可以接受联合类型(Union)的 pydantic 字段，请确保验证器明确知道这些类型之间的区别。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
   <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Video</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">video_id</span><span class="p">:</span> <span class="nb">int</span>
   <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
   <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">content</span><span class="p">:</span> <span class="n">Article</span> <span class="o">|</span> <span class="n">Video</span>


<span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;video_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="c1"># OUTPUT: Article</span>
<span class="c1"># Article 非常包容，所有字段都是可选的，允许任何字典生效</span>
</code></pre></div>
<p><strong>解决方案:</strong></p>
<ol>
<li>
<p>验证输入只允许有效字段并在提供未知数时引发错误</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Extra</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
   <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>

   <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">Extra</span><span class="o">.</span><span class="n">forbid</span>


<span class="k">class</span> <span class="nc">Video</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">video_id</span><span class="p">:</span> <span class="nb">int</span>
   <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
   <span class="n">extra</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>

   <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">Extra</span><span class="o">.</span><span class="n">forbid</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">content</span><span class="p">:</span> <span class="n">Article</span> <span class="o">|</span> <span class="n">Video</span>
</code></pre></div>
</li>
<li>
<p>如果字段很简单，请使用 Pydantic 的 Smart Union (&gt;v1.9)</p>
<p>如果字段很简单，如 <code>int</code> 或 <code>bool</code>，这是一个很好的解决方案，但它不适用于类等复杂字段。</p>
<p>没有 Smart Union :</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">field_1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span>
   <span class="n">field_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>
   <span class="n">content</span><span class="p">:</span> <span class="n">Article</span> <span class="o">|</span> <span class="n">Video</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">field_1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field_2</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;video_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">field_1</span><span class="p">)</span>
<span class="c1"># OUTPUT: True</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">field_2</span><span class="p">))</span>
<span class="c1"># OUTPUT: int</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="c1"># OUTPUT: Article</span>
</code></pre></div>
<p>有 Smart Union :</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">field_1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="nb">int</span>
   <span class="n">field_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span>
   <span class="n">content</span><span class="p">:</span> <span class="n">Article</span> <span class="o">|</span> <span class="n">Video</span>

   <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
      <span class="n">smart_union</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">field_1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field_2</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;video_id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">field_1</span><span class="p">)</span>
<span class="c1"># OUTPUT: 1</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">field_2</span><span class="p">))</span>
<span class="c1"># OUTPUT: str</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="c1"># OUTPUT: Article, 因为 smart_union 不适用于像类这样的复杂字段</span>
</code></pre></div>
</li>
<li>
<p>快速解决方法</p>
<p>正确排序字段类型: 从最严格的到宽松的校验。</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
   <span class="n">content</span><span class="p">:</span> <span class="n">Video</span> <span class="o">|</span> <span class="n">Article</span>
</code></pre></div>
</li>
</ol>
<h2 id="19-sql-第一-pydantic-第二">19. SQL-第一, Pydantic-第二<a class="headerlink" href="#19-sql-第一-pydantic-第二" title="Permanent link">&para;</a></h2>
<ul>
<li>通常，数据库处理数据的速度比 CPython 更快、更干净。</li>
<li>最好使用 SQL 执行所有复杂的连接和简单的数据操作。</li>
<li>最好在数据库中聚合 JSON 以响应嵌套对象。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.posts.service</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">UUID4</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">desc</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.functions</span> <span class="kn">import</span> <span class="n">coalesce</span>

<span class="kn">from</span> <span class="nn">src.database</span> <span class="kn">import</span> <span class="n">database</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">post_review</span><span class="p">,</span> <span class="n">products</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">get_posts</span><span class="p">(</span>
    <span class="n">creator_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mapping</span><span class="p">]:</span> 
    <span class="n">select_query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="n">func</span><span class="o">.</span><span class="n">json_build_object</span><span class="p">(</span>
                   <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;id&#39;, profiles.id&quot;</span><span class="p">),</span>
                   <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;first_name&#39;, profiles.first_name&quot;</span><span class="p">),</span>
                   <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;last_name&#39;, profiles.last_name&quot;</span><span class="p">),</span>
                   <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;username&#39;, profiles.username&quot;</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">creator_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">avatar</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">desc</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">published_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>

<span class="c1"># src.posts.schemas</span>
<span class="kn">import</span> <span class="nn">orjson</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">UUID4</span><span class="p">,</span> <span class="n">validator</span>


<span class="k">class</span> <span class="nc">PostType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">ARTICLE</span> <span class="o">=</span> <span class="s2">&quot;ARTICLE&quot;</span>
    <span class="n">COURSE</span> <span class="o">=</span> <span class="s2">&quot;COURSE&quot;</span>


<span class="k">class</span> <span class="nc">Creator</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">PostType</span>
    <span class="n">slug</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">creator</span><span class="p">:</span> <span class="n">Creator</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># before default validation</span>
    <span class="k">def</span> <span class="nf">parse_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Creator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="n">Creator</span><span class="p">:</span>
       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">creator</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># i.e. json</span>
          <span class="k">return</span> <span class="n">orjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">creator</span><span class="p">)</span>

       <span class="k">return</span> <span class="n">creator</span>

<span class="c1"># src.posts.router</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{creator_id}</span><span class="s2">/posts&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Post</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)):</span>
   <span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

   <span class="k">return</span> <span class="n">posts</span>
</code></pre></div>
<p>如果聚合数据表单 DB 是一个简单的 JSON，那么看看 Pydantic 的<code>Json</code>字段类型，它将首先加载原始 JSON。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Json</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">numbers</span><span class="p">:</span> <span class="n">Json</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
    <span class="n">dicts</span><span class="p">:</span> <span class="n">Json</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>

<span class="n">valid_a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">numbers</span><span class="o">=</span><span class="s2">&quot;[1, 2, 3]&quot;</span><span class="p">,</span> <span class="n">dicts</span><span class="o">=</span><span class="s1">&#39;{&quot;key&quot;: 1000}&#39;</span><span class="p">)</span>  <span class="c1"># becomes A(numbers=[1,2,3], dicts={&quot;key&quot;: 1000})</span>
<span class="n">invalid_a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">numbers</span><span class="o">=</span><span class="s1">&#39;[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#39;</span><span class="p">,</span> <span class="n">dicts</span><span class="o">=</span><span class="s1">&#39;{&quot;key&quot;: &quot;str instead of int&quot;}&#39;</span><span class="p">)</span>  <span class="c1"># raises ValueError</span>
</code></pre></div>
<h2 id="20-验证host如果用户可以发送公开可用的-url">20. 验证host，如果用户可以发送公开可用的 URL<a class="headerlink" href="#20-验证host如果用户可以发送公开可用的-url" title="Permanent link">&para;</a></h2>
<p>例如，我们有一个特定的入口：</p>
<ol>
<li>接受来自用户的媒体文件，</li>
<li>为此文件生成唯一的 url，</li>
<li>返回 url 给用户，</li>
<li>他们将在其他入口使用它们，例如 <code>PUT /profiles/me</code>, <code>POST /posts</code></li>
<li>这些端点只接受来自白名单主机的文件</li>
<li>使用此名称和匹配的 URL 将文件上传到 AWS。</li>
</ol>
<p>如果我们不将 URL 主机列入白名单，那么不良用户就有机会上传危险链接。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">AnyUrl</span><span class="p">,</span> <span class="n">BaseModel</span>

<span class="n">ALLOWED_MEDIA_URLS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mysite.com&quot;</span><span class="p">,</span> <span class="s2">&quot;mysite.org&quot;</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">CompanyMediaUrl</span><span class="p">(</span><span class="n">AnyUrl</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">validate_host</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">       </span><span class="sd">&quot;&quot;&quot;将 pydantic 的 AnyUrl 验证扩展到白名单 URL 主机。&quot;&quot;&quot;</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">tld</span><span class="p">,</span> <span class="n">host_type</span><span class="p">,</span> <span class="n">rebuild</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">validate_host</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_MEDIA_URLS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Forbidden host url. Upload files only to internal services.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">host</span><span class="p">,</span> <span class="n">tld</span><span class="p">,</span> <span class="n">host_type</span><span class="p">,</span> <span class="n">rebuild</span>


<span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">avatar_url</span><span class="p">:</span> <span class="n">CompanyMediaUrl</span>  <span class="c1"># only whitelisted urls for avatar</span>
</code></pre></div>
<h2 id="21-如果schema直接面向客户端在pydantic的自定义校验中抛出valueerror">21. 如果schema直接面向客户端，在pydantic的自定义校验中抛出ValueError<a class="headerlink" href="#21-如果schema直接面向客户端在pydantic的自定义校验中抛出valueerror" title="Permanent link">&para;</a></h2>
<p>它将向用户返回一个很好的详细响应。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.schemas</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>

<span class="k">class</span> <span class="nc">ProfileCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">validate_bad_words</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">username</span>  <span class="o">==</span> <span class="s2">&quot;me&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bad username, choose another&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">username</span>


<span class="c1"># src.profiles.routes</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">APIRouter</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/profiles&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">profile_data</span><span class="p">:</span> <span class="n">ProfileCreate</span><span class="p">):</span>
   <span class="k">pass</span>
</code></pre></div>
<p><strong>Response 例子:</strong></p>
<p><a class="glightbox" href="images/custom_bad_response.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="custom_bad_response" src="images/custom_bad_response.png" /></a></p>
<h2 id="22-不要忘记-fastapi-将-response-的-pydantic-对象转换为-dict然后转换为-responsemodel-的实例然后转换为-dict然后转换为-json">22. 不要忘记 FastAPI 将 Response 的 Pydantic 对象转换为 Dict，然后转换为 ResponseModel 的实例，然后转换为 Dict，然后转换为 JSON<a class="headerlink" href="#22-不要忘记-fastapi-将-response-的-pydantic-对象转换为-dict然后转换为-responsemodel-的实例然后转换为-dict然后转换为-json" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">root_validator</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ProfileResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nd">@root_validator</span>
    <span class="k">def</span> <span class="nf">debug_usage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;created pydantic model&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;called dict&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ProfileResponse</span><span class="p">()</span>
</code></pre></div>
<p><strong>日志输出:</strong></p>
<div class="highlight"><pre><span></span><code>[INFO] [2022-08-28 12:00:00.000000] created pydantic model
[INFO] [2022-08-28 12:00:00.000010] called dict
[INFO] [2022-08-28 12:00:00.000020] created pydantic model
[INFO] [2022-08-28 12:00:00.000030] called dict
</code></pre></div>
<h2 id="23-如果你必须使用sync同步-sdk-请在线程池中运行">23. 如果你必须使用sync(同步) SDK, 请在线程池中运行<a class="headerlink" href="#23-如果你必须使用sync同步-sdk-请在线程池中运行" title="Permanent link">&para;</a></h2>
<p>如果您必须使用库与外部服务交互，并且它不支持<code>async</code>(异步)，则在外部工作线程中进行 HTTP 调用。</p>
<p>举个简单的例子，我们可以使用来自 starlette 的著名的<code>run_in_threadpool</code>。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.concurrency</span> <span class="kn">import</span> <span class="n">run_in_threadpool</span>
<span class="kn">from</span> <span class="nn">my_sync_library</span> <span class="kn">import</span> <span class="n">SyncAPIClient</span> 

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">call_my_sync_library</span><span class="p">():</span>
    <span class="n">my_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_my_data</span><span class="p">()</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">SyncAPIClient</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">run_in_threadpool</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
</code></pre></div>
<h2 id="24-使用-linters-black-isort-autoflake">24. 使用 linters (black, isort, autoflake)<a class="headerlink" href="#24-使用-linters-black-isort-autoflake" title="Permanent link">&para;</a></h2>
<p>使用 linters, 您可以忘记格式化代码并专注于编写业务逻辑。</p>
<p>Black 是一个毫不妥协的代码格式化程序，它消除了您在开发过程中必须做出的许多小决定。
其他 linter 可帮助您编写更清晰的代码并遵循 PEP8。</p>
<p>使用<code>pre-commit hook</code>(预提交钩子)是一种流行的良好做法，但仅使用脚本对我们来说就可以了。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh -e</span>
<span class="nb">set</span><span class="w"> </span>-x

autoflake<span class="w"> </span>--remove-all-unused-imports<span class="w"> </span>--recursive<span class="w"> </span>--remove-unused-variables<span class="w"> </span>--in-place<span class="w"> </span>src<span class="w"> </span>tests<span class="w"> </span>--exclude<span class="o">=</span>__init__.py
isort<span class="w"> </span>src<span class="w"> </span>tests<span class="w"> </span>--profile<span class="w"> </span>black
black<span class="w"> </span>src<span class="w"> </span>tests
</code></pre></div>
<h2 id="惊喜部分">惊喜部分<a class="headerlink" href="#惊喜部分" title="Permanent link">&para;</a></h2>
<p>一些非常善良的人分享了他们自己的经验和最佳实践，绝对值得一读。</p>
<p>在项目的 <a href="https://github.com/zhanymkanov/fastapi-best-practices/issues">issues</a> 部分查看它们。</p>
<p>例如，<a href="https://github.com/zhanymkanov/fastapi-best-practices/issues/4">lowercase00</a> 详细描述了他们使用权限和授权、基于类的服务和视图、任务队列的最佳实践， 自定义响应序列化程序，使用 <a href="https://www.dynaconf.com/">dynaconf</a> 进行配置等。</p>
<p>如果您有任何关于使用 FastAPI 的经验要分享，无论是好是坏，都非常欢迎您创建一个新问题。 阅读它是我们的荣幸。</p>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年6月19日</span>
      
        <br>
        创建日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2022年8月9日</span>
      
    
  </small>
</div>



  



                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy", "content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "toc.follow"], "search": "assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="assets/javascripts/bundle.b4d07000.min.js"></script>
      
        <script src="javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>