
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="FastApi 最佳实践-中文版">
      
      
      
      
      
        <link rel="next" href="raw_en/">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.7">
    
    
      
        <title>FastApi 最佳实践-中文版</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="assets/javascripts/glightbox.min.js"></script></head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fastapi-最佳实践" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="." title="FastApi 最佳实践-中文版" class="md-header__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FastApi 最佳实践-中文版
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              最佳实践
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="." class="md-tabs__link">
        
  
    
  
  最佳实践

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="raw_en/" class="md-tabs__link">
        
  
    
  
  英文原版

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="asyncio/asyncio/" class="md-tabs__link">
          
  
    
  
  Asyncio

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="mypy/cheat_sheet_py3/" class="md-tabs__link">
          
  
    
  
  mypy

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="http/internet_protocol_suite_part_i/" class="md-tabs__link">
          
  
    
  
  HTTP

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="git/git-branch-manage/" class="md-tabs__link">
          
  
    
  
  Git

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="xml/" class="md-tabs__link">
        
  
    
  
  xml

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="sysdesign/perm_design/" class="md-tabs__link">
          
  
    
  
  系统设计

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="FastApi 最佳实践-中文版" class="md-nav__button md-logo" aria-label="FastApi 最佳实践-中文版" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    FastApi 最佳实践-中文版
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/fastapi-best-practices-zh-cn/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    FastApi 最佳实践-中文版
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    最佳实践
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    最佳实践
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#项目结构" class="md-nav__link">
    <span class="md-ellipsis">
      项目结构
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#异步路由" class="md-nav__link">
    <span class="md-ellipsis">
      异步路由
    </span>
  </a>
  
    <nav class="md-nav" aria-label="异步路由">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io密集型任务" class="md-nav__link">
    <span class="md-ellipsis">
      I/O密集型任务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-密集型任务" class="md-nav__link">
    <span class="md-ellipsis">
      CPU 密集型任务
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pydantic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#积极使用-pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      积极使用 Pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#自定义基础模型" class="md-nav__link">
    <span class="md-ellipsis">
      自定义基础模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#解耦-pydantic-basesettings" class="md-nav__link">
    <span class="md-ellipsis">
      解耦 Pydantic BaseSettings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#依赖项" class="md-nav__link">
    <span class="md-ellipsis">
      依赖项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="依赖项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#依赖注入之外" class="md-nav__link">
    <span class="md-ellipsis">
      依赖注入之外
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#链式依赖" class="md-nav__link">
    <span class="md-ellipsis">
      链式依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#解耦并重用依赖项依赖项调用会被缓存" class="md-nav__link">
    <span class="md-ellipsis">
      解耦并重用依赖项。依赖项调用会被缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#首选-async-依赖项" class="md-nav__link">
    <span class="md-ellipsis">
      首选 async 依赖项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#其他" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#遵循-rest" class="md-nav__link">
    <span class="md-ellipsis">
      遵循 REST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-响应序列化" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI 响应序列化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如果必须使用同步-sdk则在线程池中运行它" class="md-nav__link">
    <span class="md-ellipsis">
      如果必须使用同步 SDK，则在线程池中运行它
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#valueerrors-可能会变成-pydantic-validationerror" class="md-nav__link">
    <span class="md-ellipsis">
      ValueErrors 可能会变成 Pydantic ValidationError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#文档" class="md-nav__link">
    <span class="md-ellipsis">
      文档
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置数据库键命名约定" class="md-nav__link">
    <span class="md-ellipsis">
      设置数据库键命名约定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#迁移-alembic" class="md-nav__link">
    <span class="md-ellipsis">
      迁移. Alembic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置数据库命名约定" class="md-nav__link">
    <span class="md-ellipsis">
      设置数据库命名约定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql-优先pydantic-其次" class="md-nav__link">
    <span class="md-ellipsis">
      SQL 优先，Pydantic 其次
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#从第-0-天开始设置测试客户端异步" class="md-nav__link">
    <span class="md-ellipsis">
      从第 0 天开始设置测试客户端异步
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#使用ruff" class="md-nav__link">
    <span class="md-ellipsis">
      使用ruff
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#奖励部分" class="md-nav__link">
    <span class="md-ellipsis">
      奖励部分
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="raw_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    英文原版
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Asyncio
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Asyncio
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/asyncio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    中文简单指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/asyncio_en/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    中英对照指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/runner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Runner运行协程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/task_group/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TaskGroup管理协程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/cheat_sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    语法备忘录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="asyncio/api_mind_map/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API思维导图
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    mypy
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            mypy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/cheat_sheet_py3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型注解备忘录
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/builtin_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-内置类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/type_inference_type_annotations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-类型推断和类型注解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/kind_of_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-类型种类
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/class_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-类的基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/annotation_issue_at_runtime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-运行时的注解问题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/protocol_and_struct_subtyping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-协议和结构子类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/dynamic_typing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-动态类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/type_narrowing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-类型收缩
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/duck_type_compatibility/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-鸭子类型兼容
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/stub_files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-存根文件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/generics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-泛型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/more_types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-更多类型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/literal_and_enum/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-字面量和枚举
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/typeddict/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-类型字典
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/final_names_methods_classes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-最终名称、方法和类
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mypy/metaclasses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    类型系统参考-元类
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="http/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    HTTP
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            HTTP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/internet_protocol_suite_part_i/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    互联网协议入门（一）
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/internet_protocol_suite_part_ii/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    互联网协议入门（二）
    
  </span>
  

      </a>
    </li>
  

              
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/restapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Restful API 设计指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/restapibsetp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RESTful API 最佳实践
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/http-referer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTP Referer 教程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http/https/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPS 升级指南
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Git
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Git
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="git/git-branch-manage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git分支管理策略
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="git/git-remote/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git远程操作详解
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="git/git-use-process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git 使用规范流程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="git/git-cheat-sheet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常用 Git 命令清单
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="git/git-work-flow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git 协作流程
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="xml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    xml
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    系统设计
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            系统设计
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sysdesign/perm_design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    权限系统的设计
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#项目结构" class="md-nav__link">
    <span class="md-ellipsis">
      项目结构
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#异步路由" class="md-nav__link">
    <span class="md-ellipsis">
      异步路由
    </span>
  </a>
  
    <nav class="md-nav" aria-label="异步路由">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io密集型任务" class="md-nav__link">
    <span class="md-ellipsis">
      I/O密集型任务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-密集型任务" class="md-nav__link">
    <span class="md-ellipsis">
      CPU 密集型任务
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pydantic">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#积极使用-pydantic" class="md-nav__link">
    <span class="md-ellipsis">
      积极使用 Pydantic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#自定义基础模型" class="md-nav__link">
    <span class="md-ellipsis">
      自定义基础模型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#解耦-pydantic-basesettings" class="md-nav__link">
    <span class="md-ellipsis">
      解耦 Pydantic BaseSettings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#依赖项" class="md-nav__link">
    <span class="md-ellipsis">
      依赖项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="依赖项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#依赖注入之外" class="md-nav__link">
    <span class="md-ellipsis">
      依赖注入之外
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#链式依赖" class="md-nav__link">
    <span class="md-ellipsis">
      链式依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#解耦并重用依赖项依赖项调用会被缓存" class="md-nav__link">
    <span class="md-ellipsis">
      解耦并重用依赖项。依赖项调用会被缓存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#首选-async-依赖项" class="md-nav__link">
    <span class="md-ellipsis">
      首选 async 依赖项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#其他" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#遵循-rest" class="md-nav__link">
    <span class="md-ellipsis">
      遵循 REST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fastapi-响应序列化" class="md-nav__link">
    <span class="md-ellipsis">
      FastAPI 响应序列化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#如果必须使用同步-sdk则在线程池中运行它" class="md-nav__link">
    <span class="md-ellipsis">
      如果必须使用同步 SDK，则在线程池中运行它
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#valueerrors-可能会变成-pydantic-validationerror" class="md-nav__link">
    <span class="md-ellipsis">
      ValueErrors 可能会变成 Pydantic ValidationError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#文档" class="md-nav__link">
    <span class="md-ellipsis">
      文档
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置数据库键命名约定" class="md-nav__link">
    <span class="md-ellipsis">
      设置数据库键命名约定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#迁移-alembic" class="md-nav__link">
    <span class="md-ellipsis">
      迁移. Alembic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置数据库命名约定" class="md-nav__link">
    <span class="md-ellipsis">
      设置数据库命名约定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sql-优先pydantic-其次" class="md-nav__link">
    <span class="md-ellipsis">
      SQL 优先，Pydantic 其次
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#从第-0-天开始设置测试客户端异步" class="md-nav__link">
    <span class="md-ellipsis">
      从第 0 天开始设置测试客户端异步
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#使用ruff" class="md-nav__link">
    <span class="md-ellipsis">
      使用ruff
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#奖励部分" class="md-nav__link">
    <span class="md-ellipsis">
      奖励部分
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  
  


<h1 id="fastapi-最佳实践">FastAPI 最佳实践<a class="headerlink" href="#fastapi-最佳实践" title="Permanent link">&para;</a></h1>
<p>FastAPI Best Practices</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>以下是我在初创公司中使用的一套带有主观倾向的最佳实践与约定列表。</p>
<p>在过去几年的生产环境中，<br />
我们做出过一些好决策，也犯过一些错误，而这些决策极大地影响了开发者体验。<br />
其中有些经验值得分享。</p>
</div>
<div class="tabbed-block">
<p>Opinionated list of best practices and conventions I use in startups.</p>
<p>For the last several years in production,
we have been making good and bad decisions that impacted our developer experience dramatically.
Some of them are worth sharing.</p>
</div>
</div>
</div>
<h2 id="项目结构">项目结构<a class="headerlink" href="#项目结构" title="Permanent link">&para;</a></h2>
<p>Project Structure</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">中文</label><label for="__tabbed_2_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>项目结构有很多种方式，但最好的结构是<strong>一致的、直接的，并且不会令人惊讶的</strong>。</p>
<p>很多示例项目和教程倾向于按文件类型（例如 crud、routers、models）划分项目结构，这种方式适用于微服务或业务范围较小的项目。<br />
但对于拥有多个领域和模块的单体应用来说，这种结构就不太合适了。</p>
<p>我发现一种更适合这类场景的结构，它具有更好的可扩展性和可演化性，灵感来自 Netflix 的 <a href="https://github.com/Netflix/dispatch">Dispatch</a>，并在此基础上做了一些小的改动：</p>
<div class="highlight"><pre><span></span><code>fastapi-project
├── alembic/
├── src
│   ├── auth
│   │   ├── router.py
│   │   ├── schemas.py  # pydantic 模型
│   │   ├── models.py  # 数据库模型
│   │   ├── dependencies.py
│   │   ├── config.py  # 本地配置
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── aws
│   │   ├── client.py  # 用于外部服务通信的客户端模型
│   │   ├── schemas.py
│   │   ├── config.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   └── utils.py
│   └── posts
│   │   ├── router.py
│   │   ├── schemas.py
│   │   ├── models.py
│   │   ├── dependencies.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── config.py  # 全局配置
│   ├── models.py  # 全局模型
│   ├── exceptions.py  # 全局异常
│   ├── pagination.py  # 全局模块，例如分页
│   ├── database.py  # 数据库连接相关
│   └── main.py
├── tests/
│   ├── auth
│   ├── aws
│   └── posts
├── templates/
│   └── index.html
├── requirements
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
├── .env
├── .gitignore
├── logging.ini
└── alembic.ini
</code></pre></div>
<ol>
<li>
<p>将所有领域模块目录存放于 <code>src</code> 文件夹中  </p>
<ol>
<li><code>src/</code> - 应用的最高层级，包含通用模型、配置项和常量等  </li>
<li><code>src/main.py</code> - 项目入口，初始化 FastAPI 应用  </li>
</ol>
</li>
<li>
<p>每个包（模块）都拥有自己的 router、schemas、models 等：</p>
<ol>
<li><code>router.py</code> - 每个模块的核心，包含所有接口定义  </li>
<li><code>schemas.py</code> - 定义 Pydantic 模型  </li>
<li><code>models.py</code> - 定义数据库模型  </li>
<li><code>service.py</code> - 模块内的业务逻辑  </li>
<li><code>dependencies.py</code> - 路由依赖  </li>
<li><code>constants.py</code> - 模块常量和错误码  </li>
<li><code>config.py</code> - 模块配置项（例如环境变量）  </li>
<li><code>utils.py</code> - 非业务逻辑函数，例如响应格式化、数据补充等  </li>
<li><code>exceptions.py</code> - 模块自定义异常，例如 <code>PostNotFound</code>、<code>InvalidUserData</code>  </li>
</ol>
</li>
<li>
<p>当某个模块需要使用其他模块的服务、依赖或常量时——请使用<strong>显式模块名进行导入</strong>。</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">auth_constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.notifications</span><span class="w"> </span><span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">notification_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.posts.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ErrorCode</span> <span class="k">as</span> <span class="n">PostsErrorCode</span>  <span class="c1"># 如果我们在每个包的常量模块中都有标准错误代码</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>There are many ways to structure a project, but the best structure is one that is consistent, straightforward, and free of surprises.</p>
<p>Many example projects and tutorials divide the project by file type (e.g., crud, routers, models), which works well for microservices or projects with fewer scopes. However, this approach didn't fit our monolith with many domains and modules.</p>
<p>The structure I found more scalable and evolvable for these cases is inspired by Netflix's <a href="https://github.com/Netflix/dispatch">Dispatch</a>, with some minor modifications.</p>
<div class="highlight"><pre><span></span><code>fastapi-project
├── alembic/
├── src
│   ├── auth
│   │   ├── router.py
│   │   ├── schemas.py  # pydantic models
│   │   ├── models.py  # db models
│   │   ├── dependencies.py
│   │   ├── config.py  # local configs
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── aws
│   │   ├── client.py  # client model for external service communication
│   │   ├── schemas.py
│   │   ├── config.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   └── utils.py
│   └── posts
│   │   ├── router.py
│   │   ├── schemas.py
│   │   ├── models.py
│   │   ├── dependencies.py
│   │   ├── constants.py
│   │   ├── exceptions.py
│   │   ├── service.py
│   │   └── utils.py
│   ├── config.py  # global configs
│   ├── models.py  # global models
│   ├── exceptions.py  # global exceptions
│   ├── pagination.py  # global module e.g. pagination
│   ├── database.py  # db connection related stuff
│   └── main.py
├── tests/
│   ├── auth
│   ├── aws
│   └── posts
├── templates/
│   └── index.html
├── requirements
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
├── .env
├── .gitignore
├── logging.ini
└── alembic.ini
</code></pre></div>
<ol>
<li>Store all domain directories inside <code>src</code> folder</li>
<li><code>src/</code> - highest level of an app, contains common models, configs, and constants, etc.</li>
<li><code>src/main.py</code> - root of the project, which inits the FastAPI app</li>
<li>Each package has its own router, schemas, models, etc.</li>
<li><code>router.py</code> - is a core of each module with all the endpoints</li>
<li><code>schemas.py</code> - for pydantic models</li>
<li><code>models.py</code> - for db models</li>
<li><code>service.py</code> - module specific business logic  </li>
<li><code>dependencies.py</code> - router dependencies</li>
<li><code>constants.py</code> - module specific constants and error codes</li>
<li><code>config.py</code> - e.g. env vars</li>
<li><code>utils.py</code> - non-business logic functions, e.g. response normalization, data enrichment, etc.</li>
<li><code>exceptions.py</code> - module specific exceptions, e.g. <code>PostNotFound</code>, <code>InvalidUserData</code></li>
<li>When package requires services or dependencies or constants from other packages - import them with an explicit module name</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">auth_constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.notifications</span><span class="w"> </span><span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">notification_service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.posts.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ErrorCode</span> <span class="k">as</span> <span class="n">PostsErrorCode</span>  <span class="c1"># in case we have Standard ErrorCode in constants module of each package</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="异步路由">异步路由<a class="headerlink" href="#异步路由" title="Permanent link">&para;</a></h2>
<p>Async Routes</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">中文</label><label for="__tabbed_3_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>FastAPI 本质上是一个异步框架。它设计用来配合异步 I/O 操作运行，这也是它如此高效的原因。</p>
<p>不过，FastAPI 并不会强制你只能使用 <code>async</code> 路由，开发者同样可以使用 <code>sync</code> 路由。这可能会让初学者误以为二者是等价的，但实际上并不是。</p>
</div>
<div class="tabbed-block">
<p>FastAPI is an async framework, in the first place. It is designed to work with async I/O operations and that is the reason it is so fast.</p>
<p>However, FastAPI doesn't restrict you to use only <code>async</code> routes, and the developer can use <code>sync</code> routes as well. This might confuse beginner developers into believing that they are the same, but they are not.</p>
</div>
</div>
</div>
<h3 id="io密集型任务">I/O密集型任务<a class="headerlink" href="#io密集型任务" title="Permanent link">&para;</a></h3>
<p>I/O Intensive Tasks</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">中文</label><label for="__tabbed_4_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在底层，FastAPI 可以<a href="https://fastapi.tiangolo.com/async/#path-operation-functions">高效地处理</a>异步和同步 I/O 操作：</p>
<ul>
<li>FastAPI 会将 <code>sync</code> 路由放入<a href="https://en.wikipedia.org/wiki/Thread_pool">线程池</a>中运行，<br />
  阻塞型 I/O 操作不会阻止 <a href="https://docs.python.org/3/library/asyncio-eventloop.html">事件循环</a> 执行其他任务。</li>
<li>如果路由定义为 <code>async</code>，则会通过 <code>await</code> 正常调用，<br />
  FastAPI 会信任你只执行非阻塞的 I/O 操作。</li>
</ul>
<p>需要注意的是，如果你辜负了这份信任, 并在异步路由中执行阻塞操作，则事件循环将无法运行后续任务，直到阻塞操作完成。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/terrible-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">terrible_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 阻塞 10 秒的 I/O 操作，整个进程都会被卡住</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/good-ping&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">good_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 阻塞 10 秒的 I/O 操作，但在单独线程中执行，不影响主线程</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/perfect-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">perfect_ping</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 非阻塞的 I/O 操作</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</code></pre></div>
<p><strong>当我们调用以下路由时会发生什么：</strong></p>
<ol>
<li><code>GET /terrible-ping</code><ol>
<li>FastAPI 服务器接收到请求，开始处理</li>
<li>服务器的事件循环以及队列中的所有任务都会等待 <code>time.sleep()</code> 执行完成  <ol>
<li>服务器认为 <code>time.sleep()</code> 不是 I/O 操作，因此会等待它执行完毕  </li>
<li>等待期间服务器不会接受新请求  </li>
</ol>
</li>
<li>执行完毕后服务器返回响应  <ol>
<li>响应完成后服务器开始接受新的请求  </li>
</ol>
</li>
</ol>
</li>
<li><code>GET /good-ping</code><ol>
<li>FastAPI 服务器接收到请求，开始处理  </li>
<li>FastAPI 将整个 <code>good_ping</code> 路由发送到线程池，由其中一个工作线程执行  </li>
<li><code>good_ping</code> 在执行期间，事件循环会从队列中选择下一个任务继续处理（如：接收新请求、调用数据库）  <ul>
<li>工作线程会独立于主线程（也就是我们的 FastAPI 应用）等待 <code>time.sleep</code> 完成  </li>
<li>同步操作只会阻塞该工作线程，而不会影响主线程  </li>
</ul>
</li>
<li><code>good_ping</code> 执行完成后，服务器返回响应给客户端  </li>
</ol>
</li>
<li><code>GET /perfect-ping</code><ol>
<li>FastAPI 服务器接收到请求，开始处理  </li>
<li>FastAPI 调用 <code>await asyncio.sleep(10)</code>  </li>
<li>事件循环会继续选择队列中的下一个任务继续处理（如：接收新请求、调用数据库）  </li>
<li>当 <code>asyncio.sleep(10)</code> 执行完成后，服务器继续执行路由逻辑，并将响应返回给客户端  </li>
</ol>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">关于线程池的注意事项：</p>
<ul>
<li>线程比协程消耗更多资源，因此它们不像异步 I/O 操作那样廉价。</li>
<li>线程池中的线程数量是有限的，也就是说你可能会耗尽线程资源，导致应用变慢。<a href="https://github.com/Kludex/fastapi-tips?tab=readme-ov-file#2-be-careful-with-non-async-functions">进一步阅读</a>（外部链接）</li>
</ul>
</div>
</div>
<div class="tabbed-block">
<p>Under the hood, FastAPI can <a href="https://fastapi.tiangolo.com/async/#path-operation-functions">effectively handle</a> both async and sync I/O operations.</p>
<ul>
<li>FastAPI runs <code>sync</code> routes in the <a href="https://en.wikipedia.org/wiki/Thread_pool">threadpool</a>
and blocking I/O operations won't stop the <a href="https://docs.python.org/3/library/asyncio-eventloop.html">event loop</a>
from executing the tasks.</li>
<li>If the route is defined <code>async</code> then it's called regularly via <code>await</code>
and FastAPI trusts you to do only non-blocking I/O operations.</li>
</ul>
<p>The caveat is that if you violate that trust and execute blocking operations within async routes,
the event loop will not be able to run subsequent tasks until the blocking operation completes.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>


<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/terrible-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">terrible_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># I/O blocking operation for 10 seconds, the whole process will be blocked</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/good-ping&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">good_ping</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># I/O blocking operation for 10 seconds, but in a separate thread for the whole `good_ping` route</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/perfect-ping&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">perfect_ping</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># non-blocking I/O operation</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pong&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</code></pre></div>
<p><strong>What happens when we call:</strong></p>
<ol>
<li><code>GET /terrible-ping</code><ol>
<li>FastAPI server receives a request and starts handling it</li>
<li>Server's event loop and all the tasks in the queue will be waiting until <code>time.sleep()</code> is finished<ol>
<li>Server thinks <code>time.sleep()</code> is not an I/O task, so it waits until it is finished</li>
<li>Server won't accept any new requests while waiting</li>
</ol>
</li>
<li>Server returns the response.<ol>
<li>After a response, server starts accepting new requests</li>
</ol>
</li>
</ol>
</li>
<li><code>GET /good-ping</code><ol>
<li>FastAPI server receives a request and starts handling it</li>
<li>FastAPI sends the whole route <code>good_ping</code> to the threadpool, where a worker thread will run the function</li>
<li>While <code>good_ping</code> is being executed, event loop selects next tasks from the queue and works on them (e.g. accept new request, call db)<ul>
<li>Independently of main thread (i.e. our FastAPI app),
    worker thread will be waiting for <code>time.sleep</code> to finish.</li>
<li>Sync operation blocks only the side thread, not the main one.</li>
</ul>
</li>
<li>When <code>good_ping</code> finishes its work, server returns a response to the client</li>
</ol>
</li>
<li><code>GET /perfect-ping</code><ol>
<li>FastAPI server receives a request and starts handling it</li>
<li>FastAPI awaits <code>asyncio.sleep(10)</code></li>
<li>Event loop selects next tasks from the queue and works on them (e.g. accept new request, call db)</li>
<li>When <code>asyncio.sleep(10)</code> is done, servers finishes the execution of the route and returns a response to the client</li>
</ol>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Notes on the thread pool:</p>
<ul>
<li>Threads require more resources than coroutines, so they are not as cheap as async I/O operations.</li>
<li>Thread pool has a limited number of threads, i.e. you might run out of threads and your app will become slow. <a href="https://github.com/Kludex/fastapi-tips?tab=readme-ov-file#2-be-careful-with-non-async-functions">Read more</a> (external link)</li>
</ul>
</div>
</div>
</div>
</div>
<h3 id="cpu-密集型任务">CPU 密集型任务<a class="headerlink" href="#cpu-密集型任务" title="Permanent link">&para;</a></h3>
<p>CPU Intensive Tasks</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">中文</label><label for="__tabbed_5_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>第二个注意事项是，非阻塞的可等待任务或被发送到线程池的操作必须是 I/O 密集型任务（例如：打开文件、数据库调用、外部 API 调用）。</p>
<ul>
<li>等待 CPU 密集型任务（例如：重计算、数据处理、视频转码）是没有意义的，因为 CPU 需要工作才能完成这些任务，而 I/O 操作则是外部任务，服务器在等待 I/O 操作完成时不做任何事情，因此可以继续执行下一个任务。</li>
<li>在其他线程中运行 CPU 密集型任务也不有效，因为存在 <a href="https://realpython.com/python-gil/">GIL</a>。<br />
  简而言之，GIL 只允许一个线程同时工作，这使得它对于 CPU 密集型任务无效。</li>
<li>如果你想优化 CPU 密集型任务，应该将它们发送到其他进程中的工作线程。</li>
</ul>
<p><strong>相关的 StackOverflow 问题：</strong></p>
<ol>
<li><a href="https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597">https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597</a>  </li>
<li>你也可以查看 <a href="https://stackoverflow.com/a/70309597/6927498">我的回答</a></li>
<li><a href="https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask">https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask</a></li>
<li><a href="https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion">https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion</a></li>
</ol>
</div>
<div class="tabbed-block">
<p>The second caveat is that operations that are non-blocking awaitables or are sent to the thread pool must be I/O intensive tasks (e.g. open file, db call, external API call).</p>
<ul>
<li>Awaiting CPU-intensive tasks (e.g. heavy calculations, data processing, video transcoding) is worthless since the CPU has to work to finish the tasks,
while I/O operations are external and server does nothing while waiting for that operations to finish, thus it can go to the next tasks.</li>
<li>Running CPU-intensive tasks in other threads also isn't effective, because of <a href="https://realpython.com/python-gil/">GIL</a>.
In short, GIL allows only one thread to work at a time, which makes it useless for CPU tasks.</li>
<li>If you want to optimize CPU intensive tasks you should send them to workers in another process.</li>
</ul>
<p><strong>Related StackOverflow questions of confused users</strong></p>
<ol>
<li><a href="https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597">https://stackoverflow.com/questions/62976648/architecture-flask-vs-fastapi/70309597#70309597</a></li>
<li>Here you can also check <a href="https://stackoverflow.com/a/70309597/6927498">my answer</a></li>
<li><a href="https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask">https://stackoverflow.com/questions/65342833/fastapi-uploadfile-is-slow-compared-to-flask</a></li>
<li><a href="https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion">https://stackoverflow.com/questions/71516140/fastapi-runs-api-calls-in-serial-instead-of-parallel-fashion</a></li>
</ol>
</div>
</div>
</div>
<h2 id="pydantic">Pydantic<a class="headerlink" href="#pydantic" title="Permanent link">&para;</a></h2>
<h3 id="积极使用-pydantic">积极使用 Pydantic<a class="headerlink" href="#积极使用-pydantic" title="Permanent link">&para;</a></h3>
<p>Excessively use Pydantic</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">中文</label><label for="__tabbed_6_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Pydantic 提供了一整套功能来验证和转换数据。</p>
<p>除了常规的字段要求（如必需字段、非必需字段、默认值等），<br />
Pydantic 还内置了全面的数据处理工具，如正则表达式、枚举、字符串操作、电子邮件验证等。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnyUrl</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MusicBand</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="n">AEROSMITH</span> <span class="o">=</span> <span class="s2">&quot;AEROSMITH&quot;</span>
<span class="n">QUEEN</span> <span class="o">=</span> <span class="s2">&quot;QUEEN&quot;</span>
<span class="n">ACDC</span> <span class="o">=</span> <span class="s2">&quot;AC/DC&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^[A-Za-z0-9-_]+$&quot;</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># 必须大于或等于 18</span>
    <span class="n">favorite_band</span><span class="p">:</span> <span class="n">MusicBand</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 只允许输入 &quot;AEROSMITH&quot;, &quot;QUEEN&quot;, &quot;AC/DC&quot;</span>
    <span class="n">website</span><span class="p">:</span> <span class="n">AnyUrl</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Pydantic has a rich set of features to validate and transform data.</p>
<p>In addition to regular features like required &amp; non-required fields with default values,
Pydantic has built-in comprehensive data processing tools like regex, enums, strings manipulation, emails validation, etc.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnyUrl</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MusicBand</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="n">AEROSMITH</span> <span class="o">=</span> <span class="s2">&quot;AEROSMITH&quot;</span>
<span class="n">QUEEN</span> <span class="o">=</span> <span class="s2">&quot;QUEEN&quot;</span>
<span class="n">ACDC</span> <span class="o">=</span> <span class="s2">&quot;AC/DC&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserBase</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">min_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^[A-Za-z0-9-_]+$&quot;</span><span class="p">)</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># must be greater or equal to 18</span>
    <span class="n">favorite_band</span><span class="p">:</span> <span class="n">MusicBand</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># only &quot;AEROSMITH&quot;, &quot;QUEEN&quot;, &quot;AC/DC&quot; values are allowed to be inputted</span>
    <span class="n">website</span><span class="p">:</span> <span class="n">AnyUrl</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="自定义基础模型">自定义基础模型<a class="headerlink" href="#自定义基础模型" title="Permanent link">&para;</a></h3>
<p>Custom Base Model</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">中文</label><label for="__tabbed_7_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>拥有一个可控的全局基础模型可以让我们自定义应用中的所有模型。例如，我们可以强制执行标准的日期时间格式或为所有基础模型的子类引入一个通用方法。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">zoneinfo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZoneInfo</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">jsonable_encoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ConfigDict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">datetime_to_gmt_str</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="n">json_encoders</span><span class="o">=</span><span class="p">{</span><span class="n">datetime</span><span class="p">:</span> <span class="n">datetime_to_gmt_str</span><span class="p">},</span>
        <span class="n">populate_by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serializable_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;返回一个只包含可序列化字段的字典。&quot;&quot;&quot;</span>
        <span class="n">default_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonable_encoder</span><span class="p">(</span><span class="n">default_dict</span><span class="p">)</span>
</code></pre></div>
<p>在上面的示例中，我们决定创建一个全局基础模型，该模型：</p>
<ul>
<li>将所有的日期时间字段序列化为具有明确时区的标准格式</li>
<li>提供一个方法来返回只包含可序列化字段的字典</li>
</ul>
</div>
<div class="tabbed-block">
<p>Having a controllable global base model allows us to customize all the models within the app. For instance, we can enforce a standard datetime format or introduce a common method for all subclasses of the base model.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">zoneinfo</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZoneInfo</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">jsonable_encoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ConfigDict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">datetime_to_gmt_str</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%z&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span>
        <span class="n">json_encoders</span><span class="o">=</span><span class="p">{</span><span class="n">datetime</span><span class="p">:</span> <span class="n">datetime_to_gmt_str</span><span class="p">},</span>
        <span class="n">populate_by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serializable_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict which contains only serializable fields.&quot;&quot;&quot;</span>
        <span class="n">default_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">jsonable_encoder</span><span class="p">(</span><span class="n">default_dict</span><span class="p">)</span>
</code></pre></div>
<p>In the example above, we have decided to create a global base model that:</p>
<ul>
<li>Serializes all datetime fields to a standard format with an explicit timezone</li>
<li>Provides a method to return a dict with only serializable fields</li>
</ul>
</div>
</div>
</div>
<h3 id="解耦-pydantic-basesettings">解耦 Pydantic BaseSettings<a class="headerlink" href="#解耦-pydantic-basesettings" title="Permanent link">&para;</a></h3>
<p>Decouple Pydantic BaseSettings</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">中文</label><label for="__tabbed_8_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>BaseSettings 是读取环境变量的一个伟大创新，但如果整个应用只有一个 BaseSettings，随着时间推移可能会变得凌乱。为了提高可维护性和组织性，我们将 BaseSettings 拆分到不同的模块和领域中。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.auth.config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AuthConfig</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">JWT_ALG</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">JWT_SECRET</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">JWT_EXP</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 分钟</span>

    <span class="n">REFRESH_TOKEN_KEY</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">REFRESH_TOKEN_EXP</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">SECURE_COOKIES</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">auth_settings</span> <span class="o">=</span> <span class="n">AuthConfig</span><span class="p">()</span>


<span class="c1"># src.config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresDsn</span><span class="p">,</span> <span class="n">RedisDsn</span><span class="p">,</span> <span class="n">model_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="n">PostgresDsn</span>
    <span class="n">REDIS_URL</span><span class="p">:</span> <span class="n">RedisDsn</span>

    <span class="n">SITE_DOMAIN</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;myapp.com&quot;</span>

    <span class="n">ENVIRONMENT</span><span class="p">:</span> <span class="n">Environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">PRODUCTION</span>

    <span class="n">SENTRY_DSN</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">CORS_ORIGINS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">CORS_ORIGINS_REGEX</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">CORS_HEADERS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">APP_VERSION</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>


<span class="n">settings</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>BaseSettings was a great innovation for reading environment variables, but having a single BaseSettings for the whole app can become messy over time. To improve maintainability and organization, we have split the BaseSettings across different modules and domains.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.auth.config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AuthConfig</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">JWT_ALG</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">JWT_SECRET</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">JWT_EXP</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># minutes</span>

    <span class="n">REFRESH_TOKEN_KEY</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">REFRESH_TOKEN_EXP</span><span class="p">:</span> <span class="n">timedelta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="n">SECURE_COOKIES</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>


<span class="n">auth_settings</span> <span class="o">=</span> <span class="n">AuthConfig</span><span class="p">()</span>


<span class="c1"># src.config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresDsn</span><span class="p">,</span> <span class="n">RedisDsn</span><span class="p">,</span> <span class="n">model_validator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic_settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseSettings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">Environment</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>
    <span class="n">DATABASE_URL</span><span class="p">:</span> <span class="n">PostgresDsn</span>
    <span class="n">REDIS_URL</span><span class="p">:</span> <span class="n">RedisDsn</span>

    <span class="n">SITE_DOMAIN</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;myapp.com&quot;</span>

    <span class="n">ENVIRONMENT</span><span class="p">:</span> <span class="n">Environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">PRODUCTION</span>

    <span class="n">SENTRY_DSN</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">CORS_ORIGINS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">CORS_ORIGINS_REGEX</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">CORS_HEADERS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">APP_VERSION</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>


<span class="n">settings</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="依赖项">依赖项<a class="headerlink" href="#依赖项" title="Permanent link">&para;</a></h2>
<p>Dependencies</p>
<h3 id="依赖注入之外">依赖注入之外<a class="headerlink" href="#依赖注入之外" title="Permanent link">&para;</a></h3>
<p>Beyond Dependency Injection</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">中文</label><label for="__tabbed_9_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Pydantic 是一个很棒的模式验证器，但对于涉及调用数据库或外部服务的复杂验证，它并不够充分。</p>
<p>FastAPI 文档大多将依赖关系呈现为端点的 DI（依赖注入），但它们同样非常适合请求验证。</p>
<p>依赖关系可以用来根据数据库约束验证数据（例如，检查电子邮件是否已存在、确保用户已找到等）。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_post_by_id</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_post</span><span class="p">(</span>
    <span class="n">update_data</span><span class="p">:</span> <span class="n">PostUpdate</span><span class="p">,</span>  
    <span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
<span class="p">):</span>
    <span class="n">updated_post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">update_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">/reviews&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">ReviewsResponse</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_post_reviews</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="n">post_reviews</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reviews_service</span><span class="o">.</span><span class="n">get_by_post_id</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post_reviews</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Pydantic is a great schema validator, but for complex validations that involve calling a database or external services, it is not sufficient.</p>
<p>FastAPI documentation mostly presents dependencies as DI for endpoints, but they are also excellent for request validation.</p>
<p>Dependencies can be used to validate data against database constraints (e.g., checking if an email already exists, ensuring a user is found, etc.).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_post_by_id</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_post</span><span class="p">(</span>
    <span class="n">update_data</span><span class="p">:</span> <span class="n">PostUpdate</span><span class="p">,</span>  
    <span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
<span class="p">):</span>
    <span class="n">updated_post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">update_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_post</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/posts/</span><span class="si">{post_id}</span><span class="s2">/reviews&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">ReviewsResponse</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_post_reviews</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">)):</span>
    <span class="n">post_reviews</span> <span class="o">=</span> <span class="k">await</span> <span class="n">reviews_service</span><span class="o">.</span><span class="n">get_by_post_id</span><span class="p">(</span><span class="n">post</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post_reviews</span>
</code></pre></div>
<p>If we didn't put data validation to dependency, we would have to validate <code>post_id</code> exists
for every endpoint and write the same tests for each of them.</p>
</div>
</div>
</div>
<h3 id="链式依赖">链式依赖<a class="headerlink" href="#链式依赖" title="Permanent link">&para;</a></h3>
<p>Chain Dependencies</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">中文</label><label for="__tabbed_10_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>依赖项可以使用其他依赖项，并避免类似逻辑的代码重复。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>

<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Dependencies can use other dependencies and avoid code repetition for the the similar logic.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>

<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_post</span><span class="p">(</span><span class="n">post</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="解耦并重用依赖项依赖项调用会被缓存">解耦并重用依赖项。依赖项调用会被缓存<a class="headerlink" href="#解耦并重用依赖项依赖项调用会被缓存" title="Permanent link">&para;</a></h3>
<p>Decouple &amp; Reuse dependencies. Dependency calls are cached</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">中文</label><label for="__tabbed_11_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>依赖关系可以多次复用，并且它们不会被重新计算——FastAPI 默认会在请求的范围内缓存依赖关系的结果，<br />
即如果 <code>valid_post_id</code> 在一个路由中被调用多次，它只会被调用一次。</p>
<p>了解这一点后，我们可以将依赖关系解耦成多个操作于小范围的函数，这些函数更容易在其他路由中复用。<br />
例如，在下面的代码中，我们三次使用了 <code>parse_jwt_data</code>：</p>
<ol>
<li><code>valid_owned_post</code></li>
<li><code>valid_active_creator</code></li>
<li><code>get_user_post</code>,</li>
</ol>
<p>但 <code>parse_jwt_data</code> 只在第一次调用时被调用。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundTasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_active_creator</span><span class="p">(</span>
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">users_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserIsBanned</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="n">UserNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_post</span><span class="p">(</span>
    <span class="n">worker</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">),</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_active_creator</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;获取属于活跃用户的帖子。&quot;&quot;&quot;</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">notifications_service</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Dependencies can be reused multiple times, and they won't be recalculated - FastAPI caches dependency's result within a request's scope by default,
i.e. if <code>valid_post_id</code> gets called multiple times in one route, it will be called only once.</p>
<p>Knowing this, we can decouple dependencies onto multiple smaller functions that operate on a smaller domain and are easier to reuse in other routes.
For example, in the code below we are using <code>parse_jwt_data</code> three times:</p>
<ol>
<li><code>valid_owned_post</code></li>
<li><code>valid_active_creator</code></li>
<li><code>get_user_post</code>,</li>
</ol>
<p>but <code>parse_jwt_data</code> is called only once, in the very first call.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># dependencies.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundTasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.security</span><span class="w"> </span><span class="kn">import</span> <span class="n">OAuth2PasswordBearer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jose</span><span class="w"> </span><span class="kn">import</span> <span class="n">JWTError</span><span class="p">,</span> <span class="n">jwt</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_post_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">post</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PostNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parse_jwt_data</span><span class="p">(</span>
    <span class="n">token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">OAuth2PasswordBearer</span><span class="p">(</span><span class="n">tokenUrl</span><span class="o">=</span><span class="s2">&quot;/auth/token&quot;</span><span class="p">))</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;JWT_SECRET&quot;</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HS256&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">JWTError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidCredentials</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]}</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_owned_post</span><span class="p">(</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_post_id</span><span class="p">),</span> 
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserNotOwner</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">post</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_active_creator</span><span class="p">(</span>
    <span class="n">token_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">parse_jwt_data</span><span class="p">),</span>
<span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">users_service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">token_data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_active&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">UserIsBanned</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="n">UserNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">user</span>


<span class="c1"># router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">/posts/</span><span class="si">{post_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">PostResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_post</span><span class="p">(</span>
    <span class="n">worker</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">,</span>
    <span class="n">post</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_owned_post</span><span class="p">),</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_active_creator</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get post that belong the active user.&quot;&quot;&quot;</span>
    <span class="n">worker</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">notifications_service</span><span class="o">.</span><span class="n">send_email</span><span class="p">,</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">post</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="首选-async-依赖项">首选 <code>async</code> 依赖项<a class="headerlink" href="#首选-async-依赖项" title="Permanent link">&para;</a></h3>
<p>Prefer <code>async</code> dependencies</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">中文</label><label for="__tabbed_12_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>FastAPI 支持 <code>sync</code> 和 <code>async</code> 依赖关系，当你不需要等待任何内容时，使用 <code>sync</code> 依赖关系可能很诱人，但这可能不是最好的选择。</p>
<p>就像路由一样，<code>sync</code> 依赖关系是在线程池中运行的。而线程也有一定的成本和限制，如果你只是执行一个小的非 I/O 操作，那么使用线程池是多余的。</p>
<p><a href="https://github.com/Kludex/fastapi-tips?tab=readme-ov-file#9-your-dependencies-may-be-running-on-threads">查看更多</a> (外部链接)</p>
</div>
<div class="tabbed-block">
<p>FastAPI supports both <code>sync</code> and <code>async</code> dependencies, and there is a temptation to use <code>sync</code> dependencies, when you don't have to await anything, but that might not be the best choice.</p>
<p>Just as with routes, <code>sync</code> dependencies are run in the thread pool. And threads here also come with a price and limitations, that are redundant, if you just make a small non-I/O operation.</p>
<p><a href="https://github.com/Kludex/fastapi-tips?tab=readme-ov-file#9-your-dependencies-may-be-running-on-threads">See more</a> (external link)</p>
</div>
</div>
</div>
<h2 id="其他">其他<a class="headerlink" href="#其他" title="Permanent link">&para;</a></h2>
<p>Miscellaneous</p>
<h3 id="遵循-rest">遵循 REST<a class="headerlink" href="#遵循-rest" title="Permanent link">&para;</a></h3>
<p>Follow the REST</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:2"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><input id="__tabbed_13_2" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">中文</label><label for="__tabbed_13_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>开发 RESTful API 可以更方便地在路由中重用依赖关系，例如：</p>
<ol>
<li><code>GET /courses/:course_id</code></li>
<li><code>GET /courses/:course_id/chapters/:chapter_id/lessons</code></li>
<li><code>GET /chapters/:chapter_id</code></li>
</ol>
<p>唯一需要注意的是必须在路径中使用相同的变量名：</p>
<ul>
<li>如果你有两个端点 <code>GET /profiles/:profile_id</code> 和 <code>GET /creators/:creator_id</code>，<br />
它们都验证给定的 <code>profile_id</code> 是否存在，但 <code>GET /creators/:creator_id</code> 还会检查该个人是否为创作者，<br />
那么最好将 <code>creator_id</code> 路径变量重命名为 <code>profile_id</code> 并将这两个依赖关系链式调用。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.dependencies</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_profile_id</span><span class="p">(</span><span class="n">profile_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">profile_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ProfileNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.dependencies</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_creator_id</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="n">ProfileNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.profiles.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/profiles/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile_by_id</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;根据 ID 获取个人资料。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile_by_id</span><span class="p">(</span>
    <span class="n">creator_profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;根据 ID 获取创作者的个人资料。&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">creator_profile</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Developing RESTful API makes it easier to reuse dependencies in routes like these:</p>
<div class="highlight"><pre><span></span><code>1. `GET /courses/:course_id`
2. `GET /courses/:course_id/chapters/:chapter_id/lessons`
3. `GET /chapters/:chapter_id`
</code></pre></div>
<p>The only caveat is having to use the same variable names in the path:</p>
<ul>
<li>If you have two endpoints <code>GET /profiles/:profile_id</code> and <code>GET /creators/:creator_id</code>
that both validate whether the given <code>profile_id</code> exists,  but <code>GET /creators/:creator_id</code>
also checks if the profile is creator, then it's better to rename <code>creator_id</code> path variable to <code>profile_id</code> and chain those two dependencies.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.dependencies</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_profile_id</span><span class="p">(</span><span class="n">profile_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">profile_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ProfileNotFound</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.dependencies</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">valid_creator_id</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;is_creator&quot;</span><span class="p">]:</span>
    <span class="k">raise</span> <span class="n">ProfileNotCreator</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.profiles.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/profiles/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile_by_id</span><span class="p">(</span><span class="n">profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_profile_id</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get profile by id.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">profile</span>

<span class="c1"># src.creators.router.py</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{profile_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile_by_id</span><span class="p">(</span>
    <span class="n">creator_profile</span><span class="p">:</span> <span class="n">Mapping</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get creator&#39;s profile by id.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">creator_profile</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="fastapi-响应序列化">FastAPI 响应序列化<a class="headerlink" href="#fastapi-响应序列化" title="Permanent link">&para;</a></h3>
<p>FastAPI response serialization</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:2"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><input id="__tabbed_14_2" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">中文</label><label for="__tabbed_14_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>您可能认为您可以返回与您的路线的 <code>response_model</code> 匹配的 Pydantic 对象来进行一些优化，但您错了。</p>
<p>FastAPI 首先使用其 <code>jsonable_encoder</code> 将该 pydantic 对象转换为 dict，然后使用 <code>response_model</code> 验证数据，最后才将您的对象序列化为 JSON。</p>
<p>这意味着您的 Pydantic 模型对象被创建了两次：</p>
<ul>
<li>首先，当您明确创建它以从您的路由返回时。</li>
<li>其次，FastAPI 隐式地根据 request_model 验证响应数据。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">root_validator</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ProfileResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;创建了 Pydantic 模型&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ProfileResponse</span><span class="p">()</span>
</code></pre></div>
<p><strong>日志输出：</strong></p>
<div class="highlight"><pre><span></span><code>[INFO] [2022-08-28 12:00:00.000000] 创建了 Pydantic 模型
[INFO] [2022-08-28 12:00:00.000020] 创建了 Pydantic 模型
</code></pre></div>
</div>
<div class="tabbed-block">
<p>You may think you can return Pydantic object that matches your route's <code>response_model</code> to make some optimizations,
but you'd be wrong.</p>
<p>FastAPI first converts that pydantic object to dict with its <code>jsonable_encoder</code>, then validates 
data with your <code>response_model</code>, and only then serializes your object to JSON.</p>
<p>This means your Pydantic model object is created twice:</p>
<ul>
<li>First, when you explicitly create it to return from your route.</li>
<li>Second, implicitly by FastAPI to validate the response data according to the response_model.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">root_validator</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ProfileResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">debug_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;created pydantic model&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ProfileResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">ProfileResponse</span><span class="p">()</span>
</code></pre></div>
<p><strong>Logs Output:</strong></p>
<div class="highlight"><pre><span></span><code>[INFO] [2022-08-28 12:00:00.000000] created pydantic model
[INFO] [2022-08-28 12:00:00.000020] created pydantic model
</code></pre></div>
</div>
</div>
</div>
<h3 id="如果必须使用同步-sdk则在线程池中运行它">如果必须使用同步 SDK，则在线程池中运行它<a class="headerlink" href="#如果必须使用同步-sdk则在线程池中运行它" title="Permanent link">&para;</a></h3>
<p>If you must use sync SDK, then run it in a thread pool</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:2"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><input id="__tabbed_15_2" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">中文</label><label for="__tabbed_15_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>如果你必须使用一个与外部服务交互的库，并且它不是 <code>async</code>，<br />
那么应该在外部工作线程中进行 HTTP 调用。</p>
<p>我们可以使用 Starlette 中著名的 <code>run_in_threadpool</code>。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.concurrency</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_in_threadpool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">my_sync_library</span><span class="w"> </span><span class="kn">import</span> <span class="n">SyncAPIClient</span> 

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_my_sync_library</span><span class="p">():</span>
    <span class="n">my_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_my_data</span><span class="p">()</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">SyncAPIClient</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">run_in_threadpool</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>If you must use a library to interact with external services, and it's not <code>async</code>,
then make the HTTP calls in an external worker thread.</p>
<p>We can use the well-known <code>run_in_threadpool</code> from starlette.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.concurrency</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_in_threadpool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">my_sync_library</span><span class="w"> </span><span class="kn">import</span> <span class="n">SyncAPIClient</span> 

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_my_sync_library</span><span class="p">():</span>
    <span class="n">my_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_my_data</span><span class="p">()</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">SyncAPIClient</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">run_in_threadpool</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">make_request</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="valueerrors-可能会变成-pydantic-validationerror">ValueErrors 可能会变成 Pydantic ValidationError<a class="headerlink" href="#valueerrors-可能会变成-pydantic-validationerror" title="Permanent link">&para;</a></h3>
<p>ValueErrors might become Pydantic ValidationError</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">中文</label><label for="__tabbed_16_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>如果在 Pydantic 模式中引发 <code>ValueError</code>，且该模式直接暴露给客户端，FastAPI 会返回一个详细的响应给用户。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.schemas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProfileCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_password</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">STRONG_PASSWORD_PATTERN</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;密码必须包含至少一个小写字母、&quot;</span>
                <span class="s2">&quot;一个大写字母、&quot;</span>
                <span class="s2">&quot;一个数字或&quot;</span>
                <span class="s2">&quot;一个特殊符号&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">password</span>


<span class="c1"># src.profiles.routes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/profiles&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">profile_data</span><span class="p">:</span> <span class="n">ProfileCreate</span><span class="p">):</span>
<span class="k">pass</span>
</code></pre></div>
<p><strong>响应示例：</strong></p>
<p><a class="glightbox" href="./images/value_error_response.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="./images/value_error_response.png" width="auto" height="auto"></a></p>
</div>
<div class="tabbed-block">
<p>If you raise a <code>ValueError</code> in a Pydantic schema that is directly faced by the client, it will return a nice detailed response to users.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># src.profiles.schemas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ProfileCreate</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">valid_password</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">STRONG_PASSWORD_PATTERN</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Password must contain at least &quot;</span>
                <span class="s2">&quot;one lower character, &quot;</span>
                <span class="s2">&quot;one upper character, &quot;</span>
                <span class="s2">&quot;digit or &quot;</span>
                <span class="s2">&quot;special symbol&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">password</span>


<span class="c1"># src.profiles.routes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/profiles&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">profile_data</span><span class="p">:</span> <span class="n">ProfileCreate</span><span class="p">):</span>
<span class="k">pass</span>
</code></pre></div>
<p><strong>Response Example:</strong></p>
<p><a class="glightbox" href="./images/value_error_response.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="./images/value_error_response.png" width="auto" height="auto"></a></p>
</div>
</div>
</div>
<h3 id="文档">文档<a class="headerlink" href="#文档" title="Permanent link">&para;</a></h3>
<p>Docs</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><input id="__tabbed_17_2" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="__tabbed_17_1">中文</label><label for="__tabbed_17_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>
<p>除非你的 API 是公开的，否则默认隐藏文档。仅在选定的环境中显式显示它。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">)</span>  <span class="c1"># 解析 .env 文件中的环境变量</span>

<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">)</span>  <span class="c1"># 获取当前环境名称</span>
<span class="n">SHOW_DOCS_ENVIRONMENT</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span><span class="p">)</span>  <span class="c1"># 显式列出允许的环境</span>

<span class="n">app_configs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My Cool API&quot;</span><span class="p">}</span>
<span class="k">if</span> <span class="n">ENVIRONMENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SHOW_DOCS_ENVIRONMENT</span><span class="p">:</span>
<span class="n">app_configs</span><span class="p">[</span><span class="s2">&quot;openapi_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># 将文档的 URL 设置为 None</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="o">**</span><span class="n">app_configs</span><span class="p">)</span>
</code></pre></div>
</li>
<li>
<p>帮助 FastAPI 生成易于理解的文档</p>
<ol>
<li>设置 <code>response_model</code>、<code>status_code</code>、<code>description</code> 等。</li>
<li>如果模型和状态不同，使用 <code>responses</code> 路由属性为不同的响应添加文档</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">status</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/endpoints&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">DefaultResponseModel</span><span class="p">,</span>  <span class="c1"># 默认的响应 Pydantic 模型 </span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>  <span class="c1"># 默认状态码</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;详细描述该端点&quot;</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Endpoint Category&quot;</span><span class="p">],</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;端点概述&quot;</span><span class="p">,</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">OkResponse</span><span class="p">,</span> <span class="c1"># 自定义 Pydantic 模型用于 200 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;成功响应&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">CreatedResponse</span><span class="p">,</span>  <span class="c1"># 自定义 Pydantic 模型用于 201 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;根据用户请求创建某物&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_202_ACCEPTED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">AcceptedResponse</span><span class="p">,</span>  <span class="c1"># 自定义 Pydantic 模型用于 202 响应</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;接受请求并稍后处理&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">documented_route</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>
</li>
</ol>
<p>这将生成类似这样的文档：
<a class="glightbox" href="images/custom_responses.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="FastAPI 生成的自定义响应文档" src="images/custom_responses.png" title="自定义响应文档" /></a></p>
</div>
<div class="tabbed-block">
<ol>
<li>Unless your API is public, hide docs by default. Show it explicitly on the selected envs only.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="s2">&quot;.env&quot;</span><span class="p">)</span>  <span class="c1"># parse .env file for env variables</span>

<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">config</span><span class="p">(</span><span class="s2">&quot;ENVIRONMENT&quot;</span><span class="p">)</span>  <span class="c1"># get current env name</span>
<span class="n">SHOW_DOCS_ENVIRONMENT</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span><span class="p">)</span>  <span class="c1"># explicit list of allowed envs</span>

<span class="n">app_configs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;My Cool API&quot;</span><span class="p">}</span>
<span class="k">if</span> <span class="n">ENVIRONMENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SHOW_DOCS_ENVIRONMENT</span><span class="p">:</span>
<span class="n">app_configs</span><span class="p">[</span><span class="s2">&quot;openapi_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># set url for docs as null</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="o">**</span><span class="n">app_configs</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>Help FastAPI to generate an easy-to-understand docs<ol>
<li>Set <code>response_model</code>, <code>status_code</code>, <code>description</code>, etc.</li>
<li>If models and statuses vary, use <code>responses</code> route attribute to add docs for different responses</li>
</ol>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">status</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/endpoints&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">DefaultResponseModel</span><span class="p">,</span>  <span class="c1"># default response pydantic model </span>
    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">,</span>  <span class="c1"># default status code</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Description of the well documented endpoint&quot;</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Endpoint Category&quot;</span><span class="p">],</span>
    <span class="n">summary</span><span class="o">=</span><span class="s2">&quot;Summary of the Endpoint&quot;</span><span class="p">,</span>
    <span class="n">responses</span><span class="o">=</span><span class="p">{</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_200_OK</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">OkResponse</span><span class="p">,</span> <span class="c1"># custom pydantic model for 200 response</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Ok Response&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_201_CREATED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">CreatedResponse</span><span class="p">,</span>  <span class="c1"># custom pydantic model for 201 response</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Creates something from user request &quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">status</span><span class="o">.</span><span class="n">HTTP_202_ACCEPTED</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">AcceptedResponse</span><span class="p">,</span>  <span class="c1"># custom pydantic model for 202 response</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Accepts request and handles it later&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">documented_route</span><span class="p">():</span>
    <span class="k">pass</span>
</code></pre></div>
<p>Will generate docs like this:
<a class="glightbox" href="images/custom_responses.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="FastAPI Generated Custom Response Docs" src="images/custom_responses.png" title="Custom Response Docs" /></a></p>
</div>
</div>
</div>
<h3 id="设置数据库键命名约定">设置数据库键命名约定<a class="headerlink" href="#设置数据库键命名约定" title="Permanent link">&para;</a></h3>
<p>Set DB keys naming conventions</p>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><input id="__tabbed_18_2" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="__tabbed_18_1">中文</label><label for="__tabbed_18_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>显式设置索引命名以符合数据库的约定优于使用 SQLAlchemy 的默认命名。</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>

<span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(column_0_label)s</span><span class="s2">_idx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_key&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">_check&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_fkey&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_pkey&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Explicitly setting the indexes' namings according to your database's convention is preferable over sqlalchemy's.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>

<span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ix&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(column_0_label)s</span><span class="s2">_idx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_key&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ck&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(constraint_name)s</span><span class="s2">_check&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_name)s</span><span class="s2">_fkey&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(table_name)s</span><span class="s2">_pkey&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">naming_convention</span><span class="o">=</span><span class="n">POSTGRES_INDEXES_NAMING_CONVENTION</span><span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="迁移-alembic">迁移. Alembic<a class="headerlink" href="#迁移-alembic" title="Permanent link">&para;</a></h3>
<p>Migrations. Alembic</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:2"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><input id="__tabbed_19_2" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="__tabbed_19_1">中文</label><label for="__tabbed_19_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ol>
<li>迁移必须是静态的且可回退的。
如果你的迁移依赖于动态生成的数据，确保唯一动态的部分是数据本身，而不是它的结构。</li>
<li>使用描述性名称和简短的描述生成迁移文件。描述是必需的，并且应该解释更改内容。</li>
<li>为新的迁移文件设置易读的文件模板。我们使用 <code>*date*_*slug*.py</code> 模式，例如 <code>2022-08-24_post_content_idx.py</code></li>
</ol>
<div class="highlight"><pre><span></span><code># alembic.ini
file_template = %%(year)d-%%(month).2d-%%(day).2d_%%(slug)s
</code></pre></div>
</div>
<div class="tabbed-block">
<ol>
<li>Migrations must be static and revertable.
If your migrations depend on dynamically generated data, then
make sure the only thing that is dynamic is the data itself, not its structure.</li>
<li>Generate migrations with descriptive names &amp; slugs. Slug is required and should explain the changes.</li>
<li>Set human-readable file template for new migrations. We use <code>*date*_*slug*.py</code> pattern, e.g. <code>2022-08-24_post_content_idx.py</code></li>
</ol>
<div class="highlight"><pre><span></span><code># alembic.ini
file_template = %%(year)d-%%(month).2d-%%(day).2d_%%(slug)s
</code></pre></div>
</div>
</div>
</div>
<h3 id="设置数据库命名约定">设置数据库命名约定<a class="headerlink" href="#设置数据库命名约定" title="Permanent link">&para;</a></h3>
<p>Set DB naming conventions</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:2"><input checked="checked" id="__tabbed_20_1" name="__tabbed_20" type="radio" /><input id="__tabbed_20_2" name="__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="__tabbed_20_1">中文</label><label for="__tabbed_20_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>保持名称的一致性非常重要。我们遵循的一些规则：</p>
<ol>
<li>使用小写蛇形命名法（lower_case_snake）</li>
<li>使用单数形式（例如 <code>post</code>、<code>post_like</code>、<code>user_playlist</code>）</li>
<li>将相似的表分组在同一个模块前缀下，例如 <code>payment_account</code>、<code>payment_bill</code>、<code>post</code>、<code>post_like</code></li>
<li>在所有表中保持一致性，但具体命名是可以接受的，例如：<ol>
<li>在所有表中使用 <code>profile_id</code>，但如果某些表只需要创作者的个人资料，则使用 <code>creator_id</code></li>
<li>对于所有抽象表（如 <code>post_like</code>、<code>post_view</code>）使用 <code>post_id</code>，但在相关模块中使用具体命名，如在 <code>chapters.course_id</code> 中使用 <code>course_id</code></li>
</ol>
</li>
<li>对于日期时间，使用 <code>_at</code> 后缀</li>
<li>对于日期，使用 <code>_date</code> 后缀</li>
</ol>
</div>
<div class="tabbed-block">
<p>Being consistent with names is important. Some rules we followed:</p>
<ol>
<li>lower_case_snake</li>
<li>singular form (e.g. <code>post</code>, <code>post_like</code>, <code>user_playlist</code>)</li>
<li>group similar tables with module prefix, e.g. <code>payment_account</code>, <code>payment_bill</code>, <code>post</code>, <code>post_like</code></li>
<li>stay consistent across tables, but concrete namings are ok, e.g.<ol>
<li>use <code>profile_id</code> in all tables, but if some of them need only profiles that are creators, use <code>creator_id</code></li>
<li>use <code>post_id</code> for all abstract tables like <code>post_like</code>, <code>post_view</code>, but use concrete naming in relevant modules like <code>course_id</code> in <code>chapters.course_id</code></li>
</ol>
</li>
<li><code>_at</code> suffix for datetime</li>
<li><code>_date</code> suffix for date</li>
</ol>
</div>
</div>
</div>
<h3 id="sql-优先pydantic-其次">SQL 优先，Pydantic 其次<a class="headerlink" href="#sql-优先pydantic-其次" title="Permanent link">&para;</a></h3>
<p>SQL-first. Pydantic-second</p>
<div class="tabbed-set tabbed-alternate" data-tabs="21:2"><input checked="checked" id="__tabbed_21_1" name="__tabbed_21" type="radio" /><input id="__tabbed_21_2" name="__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="__tabbed_21_1">中文</label><label for="__tabbed_21_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>通常，数据库处理数据的速度和清晰度要远远快于 CPython。</li>
<li>最好通过 SQL 来执行所有复杂的联接和简单的数据操作。</li>
<li>最好将嵌套对象的 JSON 聚合到数据库中，以便更高效地响应。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.posts.service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID4</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">desc</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">coalesce</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">database</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">post_review</span><span class="p">,</span> <span class="n">products</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_posts</span><span class="p">(</span>
    <span class="n">creator_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> 
    <span class="n">select_query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="n">func</span><span class="o">.</span><span class="n">json_build_object</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;id&#39;, profiles.id&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;first_name&#39;, profiles.first_name&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;last_name&#39;, profiles.last_name&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;username&#39;, profiles.username&quot;</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">creator_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">avatar</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">desc</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">published_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>

<span class="c1"># src.posts.schemas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">UUID4</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Creator</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="n">slug</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">creator</span><span class="p">:</span> <span class="n">Creator</span>


<span class="c1"># src.posts.router</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{creator_id}</span><span class="s2">/posts&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Post</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)):</span>
<span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

<span class="k">return</span> <span class="n">posts</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<ul>
<li>Usually, database handles data processing much faster and cleaner than CPython will ever do.</li>
<li>It's preferable to do all the complex joins and simple data manipulations with SQL.</li>
<li>It's preferable to aggregate JSONs in DB for responses with nested objects.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># src.posts.service</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID4</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">desc</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">coalesce</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.database</span><span class="w"> </span><span class="kn">import</span> <span class="n">database</span><span class="p">,</span> <span class="n">posts</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">post_review</span><span class="p">,</span> <span class="n">products</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_posts</span><span class="p">(</span>
    <span class="n">creator_id</span><span class="p">:</span> <span class="n">UUID4</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span> 
    <span class="n">select_query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
                <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                <span class="n">func</span><span class="o">.</span><span class="n">json_build_object</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;id&#39;, profiles.id&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;first_name&#39;, profiles.first_name&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;last_name&#39;, profiles.last_name&quot;</span><span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;username&#39;, profiles.username&quot;</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profiles</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">==</span> <span class="n">creator_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span>
            <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">avatar</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">desc</span><span class="p">(</span><span class="n">coalesce</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">published_at</span><span class="p">,</span> <span class="n">posts</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="k">await</span> <span class="n">database</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">(</span><span class="n">select_query</span><span class="p">)</span>

<span class="c1"># src.posts.schemas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">UUID4</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Creator</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="n">first_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">last_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Post</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">UUID4</span>
    <span class="n">slug</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">creator</span><span class="p">:</span> <span class="n">Creator</span>


<span class="c1"># src.posts.router</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>


<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/creators/</span><span class="si">{creator_id}</span><span class="s2">/posts&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="nb">list</span><span class="p">[</span><span class="n">Post</span><span class="p">])</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_creator_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">valid_creator_id</span><span class="p">)):</span>
<span class="n">posts</span> <span class="o">=</span> <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">get_posts</span><span class="p">(</span><span class="n">creator</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

<span class="k">return</span> <span class="n">posts</span>
</code></pre></div>
</div>
</div>
</div>
<h3 id="从第-0-天开始设置测试客户端异步">从第 0 天开始设置测试客户端异步<a class="headerlink" href="#从第-0-天开始设置测试客户端异步" title="Permanent link">&para;</a></h3>
<p>Set tests client async from day 0</p>
<div class="tabbed-set tabbed-alternate" data-tabs="22:2"><input checked="checked" id="__tabbed_22_1" name="__tabbed_22" type="radio" /><input id="__tabbed_22_2" name="__tabbed_22" type="radio" /><div class="tabbed-labels"><label for="__tabbed_22_1">中文</label><label for="__tabbed_22_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>编写带有数据库的集成测试很可能会导致将来出现事件循环错误。
请立即设置异步测试客户端，例如 <a href="https://github.com/encode/starlette/issues/652">httpx</a>。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">async_asgi_testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>  <span class="c1"># 初始化的 FastAPI 应用</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">TestClient</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;9000&quot;</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="n">ASGITransport</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)),</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_post</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
</code></pre></div>
<p>除非你有同步数据库连接（抱歉？）或者不打算编写集成测试。</p>
</div>
<div class="tabbed-block">
<p>Writing integration tests with DB will most likely lead to messed up event loop errors in the future.
Set the async test client immediately, e.g. <a href="https://github.com/encode/starlette/issues/652">httpx</a></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">async_asgi_testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>  <span class="c1"># inited FastAPI app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">TestClient</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;9000&quot;</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">AsyncClient</span><span class="p">(</span><span class="n">transport</span><span class="o">=</span><span class="n">ASGITransport</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)),</span> <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://test&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_create_post</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">TestClient</span><span class="p">):</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/posts&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
</code></pre></div>
<p>Unless you have sync db connections (excuse me?) or aren't planning to write integration tests.</p>
</div>
</div>
</div>
<h3 id="使用ruff">使用ruff<a class="headerlink" href="#使用ruff" title="Permanent link">&para;</a></h3>
<p>Use ruff</p>
<div class="tabbed-set tabbed-alternate" data-tabs="23:2"><input checked="checked" id="__tabbed_23_1" name="__tabbed_23" type="radio" /><input id="__tabbed_23_2" name="__tabbed_23" type="radio" /><div class="tabbed-labels"><label for="__tabbed_23_1">中文</label><label for="__tabbed_23_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>使用 linter，可以忘记格式化代码，专注于编写业务逻辑。</p>
<p><a href="https://github.com/astral-sh/ruff">Ruff</a> 是一个 "极速" 的新 linter，取代了 black、autoflake、isort，并支持超过 600 条 lint 规则。</p>
<p>使用 pre-commit 钩子是一个流行的好做法，但仅使用脚本对我们来说也可以。</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh -e</span>
<span class="nb">set</span><span class="w"> </span>-x

ruff<span class="w"> </span>check<span class="w"> </span>--fix<span class="w"> </span>src
ruff<span class="w"> </span>format<span class="w"> </span>src
</code></pre></div>
</div>
<div class="tabbed-block">
<p>With linters, you can forget about formatting the code and focus on writing the business logic.</p>
<p><a href="https://github.com/astral-sh/ruff">Ruff</a> is "blazingly-fast" new linter that replaces black, autoflake, isort, and supports more than 600 lint rules.</p>
<p>It's a popular good practice to use pre-commit hooks, but just using the script was ok for us.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh -e</span>
<span class="nb">set</span><span class="w"> </span>-x

ruff<span class="w"> </span>check<span class="w"> </span>--fix<span class="w"> </span>src
ruff<span class="w"> </span>format<span class="w"> </span>src
</code></pre></div>
</div>
</div>
</div>
<h2 id="奖励部分">奖励部分<a class="headerlink" href="#奖励部分" title="Permanent link">&para;</a></h2>
<p>Bonus Section</p>
<div class="tabbed-set tabbed-alternate" data-tabs="24:2"><input checked="checked" id="__tabbed_24_1" name="__tabbed_24" type="radio" /><input id="__tabbed_24_2" name="__tabbed_24" type="radio" /><div class="tabbed-labels"><label for="__tabbed_24_1">中文</label><label for="__tabbed_24_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>一些非常友善的人分享了他们的经验和最佳实践，绝对值得一读。
请查看项目的 <a href="https://github.com/zhanymkanov/fastapi-best-practices/issues">issues</a> 部分。</p>
<p>例如， <a href="https://github.com/zhanymkanov/fastapi-best-practices/issues/4">lowercase00</a> 
详细描述了他们在处理权限与认证、基于类的服务与视图、任务队列、自定义响应序列化器、使用 dynaconf 配置等方面的最佳实践。</p>
<p>如果你有关于使用 FastAPI 的经验，无论是好是坏，都非常欢迎创建一个新的 issue。我们很高兴阅读它。</p>
</div>
<div class="tabbed-block">
<p>Some very kind people shared their own experience and best practices that are definitely worth reading.
Check them out at <a href="https://github.com/zhanymkanov/fastapi-best-practices/issues">issues</a> section of the project.</p>
<p>For instance, <a href="https://github.com/zhanymkanov/fastapi-best-practices/issues/4">lowercase00</a>
has described in details their best practices working with permissions &amp; auth, class-based services &amp; views,
task queues, custom response serializers, configuration with dynaconf, etc.  </p>
<p>If you have something to share about your experience working with FastAPI, whether it's good or bad,
you are very welcome to create a new issue. It is our pleasure to read it.</p>
</div>
</div>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2025年4月11日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2022年8月9日</span>
  </span>

    
    
    
  </aside>



  



                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy", "content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "toc.follow"], "search": "assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>